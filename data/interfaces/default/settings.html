<%inherit file="base.html"/>
<%!
    import os
    import sys

    import plexpy
    from plexpy import common, notifiers, newsletters
    from plexpy.helpers import anon_url, checked

    docker_setting = 'disabled' if plexpy.DOCKER else ''
    docker_msg = '<span class="setting-message small">(Controlled by Docker Container)</span>' if plexpy.DOCKER else ''

    available_notification_agents = sorted(notifiers.available_notification_agents(), key=lambda k: k['label'].lower())
    available_newsletter_agents = sorted(newsletters.available_newsletter_agents(), key=lambda k: k['label'].lower())
%>
<%def name="headIncludes()">
</%def>

<%def name="headerIncludes()">
</%def>

<%def name="body()">
<div class="container">
    % if plexpy.CONFIG.CHECK_DOCKER_MOUNT and plexpy.DOCKER and not plexpy.DOCKER_MOUNT:
    <div class="row">
        <div class="col-md-12">
            <div class="alert alert-danger docker-mount" role="alert">
                Docker容器的 <span class="inline-pre">/config</span> 卷挂载未正确配置。
                当容器被重新创建或更新时，所有数据可能会被清除。
            </div>
        </div>
    </div>
    % endif
    <div class="row">
        <div class="col-md-12">
            <div class='card-back-full'>
                <div class="header-bar">
                    <span><i class="fa fa-cogs"></i> 设置</span>
                </div>
                <div class="button-bar">
                    % if config['show_advanced_settings'] == 1:
                    <button id="menu_link_show_advanced_settings" class="btn btn-dark active"><i class="fa fa-wrench"></i> 隐藏高级选项</button>
                    % else:
                    <button id="menu_link_show_advanced_settings" class="btn btn-dark"><i class="fa fa-wrench"></i> 显示高级选项</button>
                    % endif
                    % if config['check_github']:
                    <button id="menu_link_update_check" class="btn btn-dark"><i class="fa fa-arrow-alt-circle-up"></i> 检查更新</button>
                    % endif
                    <button id="menu_link_restart" class="btn btn-dark"><i class="fa fa-refresh"></i> 重新启动</button>
                    <button id="menu_link_shutdown" class="btn btn-dark"><i class="fa fa-power-off"></i> 关闭</button>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <!-- Nav tabs -->
        <div class="col-md-3">
            <ul class="nav-settings list-unstyled" role="tablist">
                <li role="presentation" class="active"><a id="nav-help_info" href="#tabs-help_info" aria-controls="tabs-help_info" role="tab" data-toggle="tab">帮助与信息</a></li>
                <li role="presentation"><a id="nav-tabs-general" href="#tabs-general" aria-controls="tabs-general" role="tab" data-toggle="tab">通用</a></li>
                <li role="presentation"><a id="nav-tabs-homepage" href="#tabs-homepage" aria-controls="tabs-homepage" role="tab" data-toggle="tab">主页</a></li>
                <li role="presentation"><a id="nav-tabs-web_interface" href="#tabs-web_interface" aria-controls="tabs-web_interface" role="tab" data-toggle="tab">Web界面</a></li>
                <li role="presentation"><a id="nav-tabs-plex_media_server" href="#tabs-plex_media_server" aria-controls="tabs-plex_media_server" role="tab" data-toggle="tab">Plex 媒体服务器</a></li>
                <li role="presentation"><a id="nav-tabs-notifications" href="#tabs-notifications" aria-controls="tabs-notifications" role="tab" data-toggle="tab">通知和新闻</a></li>
                <li role="presentation"><a id="nav-tabs-notification_agents" href="#tabs-notification_agents" aria-controls="tabs-notification_agents" role="tab" data-toggle="tab">通知代理</a></li>
                <li role="presentation"><a id="nav-tabs-newsletter_agents" href="#tabs-newsletter_agents" aria-controls="tabs-newsletter_agents" role="tab" data-toggle="tab">新闻代理</a></li>
                <li role="presentation"><a id="nav-tabs-3rd_party_apis" href="#tabs-3rd_party_apis" aria-controls="tabs-3rd_party_apis" role="tab" data-toggle="tab">第三方API</a></li>
                <li role="presentation"><a id="nav-tabs-import_backups" href="#tabs-import_backups" aria-controls="tabs-import_backups" role="tab" data-toggle="tab">导入和备份</a></li>
                <li role="presentation"><a id="nav-tabs-remote_app" href="#tabs-remote_app" aria-controls="tabs-remote_app" role="tab" data-toggle="tab">Tautulli 远程应用程序 <span class="pull-right"><i class="fa fa-fw fa-android"></i><i class="fa fa-fw fa-apple"></i></span></a></li>
            </ul>
        </div>
        <div class="col-md-9">
            <form action="configUpdate" method="post" class="form" id="configUpdate" data-parsley-validate>
                <input type="hidden" id="show_advanced_settings" name="show_advanced_settings" value="${config['show_advanced_settings']}" required>
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="tabs-help_info">
                        % if common.RELEASE:
                        <div class="padded-header">
                            <h3>版本 ${common.RELEASE} <small><a id="changelog-modal-link" href="#"><i class="fa fa-info-circle"></i> 更新日志</a></small></h3>
                        </div>
                        % endif
                        <div class="padded-header">
                            <h3>Tautulli 新闻</h3>
                        </div>
                        <div id="tautulli-news">
                            <div class='text-muted'><i class="fa fa-refresh fa-spin"></i> 正在加载新闻...</div>
                            <br>
                        </div>
                        <div class="padded-header">
                            <h3>Tautulli 配置</h3>
                        </div>
                        <div id="plexpy-configuration-table">
                            <div class='text-muted'><i class="fa fa-refresh fa-spin"></i> 正在加载配置...</div>
                            <br>
                        </div>
                        <div class="padded-header">
                            <h3>Tautulli 计划任务</h3>
                        </div>
                        <div id="plexpy-scheduler-table">
                            <div class='text-muted'><i class="fa fa-refresh fa-spin"></i> 正在加载计划任务...</div>
                            <br>
                        </div>
                    </div>

                    <div role="tabpanel" class="tab-pane" id="tabs-general">

                        <div class="padded-header">
                            <h3>显示设置</h3>
                        </div>

                        <div class="form-group">
                            <label for="date_format">日期格式化</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="date_format" name="date_format" value="${config['date_format']}" data-parsley-trigger="change" required>
                                </div>
                            </div>
                            <p class="help-block">设置您首选的。<a href="javascript:void(0)" data-target="#dateTimeOptionsModal" data-toggle="modal">点击这里</a> 查看参数列表。</p>
                        </div>
                        <div class="form-group">
                            <label for="date_format">时间格式</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" id="time_format" name="time_format" value="${config['time_format']}" data-parsley-trigger="change" required>
                                </div>
                            </div>
                            <p class="help-block">设置您首选的时间格式。<a href="javascript:void(0)" data-target="#dateTimeOptionsModal" data-toggle="modal">点击这里</a>查看参数列表。</p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" id="week_start_monday" name="week_start_monday" value="1" ${config['week_start_monday']}> 以星期一开始的一周
                            </label>
                            <p class="help-block">改变 "<em>播放 - 周视图</em>" 图表从星期一开始。默认情况下，图表从星期日开始。</p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" id="history_table_activity" name="history_table_activity" value="1" ${config['history_table_activity']}> 历史中的当前活动
                            </label>
                            <p class="help-block">将当前活动包括在历史中。统计数据将在流结束之前不会被计算。</p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" id="get_file_sizes" name="get_file_sizes" value="1" ${config['get_file_sizes']}> 计算总文件大小
                            </label>
                            <p class="help-block">如果您希望 Tautulli 在媒体信息表中计算电视节目/季度和艺术家/专辑的总文件大小，请启用此选项。</p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" id="log_blacklist" name="log_blacklist" value="1" ${config['log_blacklist']}> 在日志中屏蔽敏感信息
                            </label>
                            <p class="help-block">
                                在日志中使用星号（*）来屏蔽密码、访问令牌、公共IP地址和电子邮件地址。<br />
                                注意：只有在启用此设置后生成的日志才会被屏蔽。请勿在未屏蔽敏感信息的情况下公开发布您的日志！
                            </p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" id="log_blacklist_usernames" name="log_blacklist_usernames" value="1" ${config['log_blacklist_usernames']}> 在日志中隐藏用户名
                            </label>
                            <p class="help-block">
                                在日志中使用星号(*)来掩盖Plex用户名。<br />
                                注意：只有在启用此设置后的日志才会被屏蔽。
                            </p>
                        </div>

                        <div class="padded-header">
                            <h3>历史记录</h3>
                        </div>

                        <div class="form-group advanced-setting">
                            <label for="logging_ignore_interval">忽略间隔</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="logging_ignore_interval" name="logging_ignore_interval" value="${config['logging_ignore_interval']}" size="5" data-parsley-min="0" data-parsley-trigger="change" data-parsley-errors-container="#logging_ignore_interval_error" required>
                                </div>
                                <div id="logging_ignore_interval_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">播放项目在记录之前必须处于播放状态的时间间隔（以秒为单位）。设置为 0 以禁用记录。</p>
                        </div>
                        <div class="form-group">
                            <label for="movie_watched_percent">电影观看百分比</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="movie_watched_percent" name="movie_watched_percent" value="${config['movie_watched_percent']}" size="5" data-parsley-range="[50,95]" data-parsley-trigger="change" data-parsley-errors-container="#movie_watched_percent_error" required>
                                </div>
                                <div id="movie_watched_percent_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">设置电影被视为已观看的百分比。最低50%，最高95%。</p>
                        </div>
                        <div class="form-group">
                            <label for="tv_watched_percent">电视剧集观看百分比</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="tv_watched_percent" name="tv_watched_percent" value="${config['tv_watched_percent']}" size="5" data-parsley-range="[50,95]" data-parsley-trigger="change" data-parsley-errors-container="#tv_watched_percent_error" required>
                                </div>
                                <div id="tv_watched_percent_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">设置电视剧集被视为已观看的百分比。最低50%，最高95%。</p>
                        </div>
                        <div class="form-group">
                            <label for="music_watched_percent">音乐收听百分比</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="music_watched_percent" name="music_watched_percent" value="${config['music_watched_percent']}" size="5" data-parsley-range="[50,95]" data-parsley-trigger="change" data-parsley-errors-container="#music_watched_percent_error" required>
                                </div>
                                <div id="music_watched_percent_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">将音乐曲目被视为已听的百分比设置为。最低50，最高95。</p>
                        </div>
                        <div class="form-group">
                            <label for="music_watched_percent">视频观看完成行为</label>
                            <div class="row">
                                <div class="col-md-7">
                                    <select class="form-control" id="watched_marker" name="watched_marker">
                                        <option value="0" ${'selected' if config['watched_marker'] == 0 else ''}>在选定的阈值百分比下</option>
                                        <option value="1" ${'selected' if config['watched_marker'] == 1 else ''}>在最终片尾标记位置</option>
                                        <option value="2" ${'selected' if config['watched_marker'] == 2 else ''}>在第一个感谢标记位置</option>
                                        <option value="3" ${'selected' if config['watched_marker'] == 3 else ''}>最早的阈值百分比和首个感谢标记之间</option>
                                    </select>
                                </div>
                            </div>
                            <p class="help-block">决定是否使用片尾标记来确定视频项目的“已观看”状态。当标记不可用时，将使用所选的阈值百分比。</p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" id="group_history_tables" name="group_history_tables" value="1" ${config['group_history_tables']}> 群组播放历史
                            </label>
                            <p class="help-block">当进度小于观看百分比时，将相同项目和用户的组播放历史作为单个条目。</p>
                        </div>
                        <div class="form-group advanced-setting">
                            <label>重新分组播放历史记录</label>
                            <p class="help-block">
                                修复数据库中播放历史的分组。<br />
                            </p>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="btn-group">
                                        <button class="btn btn-form" type="button" id="regroup_history">重新分组</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group advanced-setting">
                            <label>刷新临时会话</label>
                            <p class="help-block">
                                尝试通过清除数据库中的所有临时会话来修复历史记录日志问题。<br />
                                警告：这将重置所有当前活动的会话。仅在历史记录日志卡住时紧急使用！
                            </p>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="btn-group">
                                        <button class="btn btn-form" type="button" id="delete_temp_sessions">刷新</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="padded-header">
                            <h3>更新</h3>
                        </div>

                        <div class="checkbox">
                            <label>
                                <input type="checkbox" id="check_github" name="check_github" value="1" ${config['check_github']}> 检查 Tautulli 更新
                            </label>
                            <p class="help-block">启用检查 Tautulli 更新。</p>
                        </div>
                        <div id="git_update_options">
                            <div class="form-group">
                                <label for="check_github_interval">更新检查间隔</label>
                                <div class="row">
                                    <div class="col-md-2">
                                        <input type="text" class="form-control" data-parsley-type="integer" id="check_github_interval" name="check_github_interval" value="${config['check_github_interval']}" size="3" data-parsley-min="1" data-parsley-trigger="change" data-parsley-errors-container="#check_github_interval_error" required>
                                    </div>
                                    <div id="check_github_interval_error" class="alert alert-danger settings-alert" role="alert"></div>
                                </div>
                                <p class="help-block">
                                    Tautulli 将检查新更新的时间间隔（以小时为单位）。最小值为 1 ，默认值为 6 。
                                </p>
                            </div>
                            % if not plexpy.SNAP and not plexpy.FROZEN:
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" id="plexpy_auto_update" name="plexpy_auto_update" value="1" ${config['plexpy_auto_update']} ${docker_setting}> 自动更新 ${docker_msg | n}
                                </label>
                                <p class="help-block">如果有更新可用，自动更新 Tautulli 。</p>
                            </div>
                            % endif
                            <div class="checkbox advanced-setting">
                                <label>
                                    <input type="checkbox" name="notify_plexpy_update_repeat" id="notify_plexpy_update_repeat" value="1" ${config['notify_plexpy_update_repeat']}> 重复 Tautulli 更新通知
                                </label>
                                <p class="help-block">
                                    启用此选项，允许 Tautulli 在每次检查更新时发送重复的更新通知。
                                    禁用仅发送一条有关每个 Tautulli 版本的通知。
                                </p>
                            </div>
                            <div class="form-group advanced-setting">
                                <label for="git_token">GitHub API 令牌</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-btn">
                                                <button class="btn btn-form reveal-token" type="button"><i class="fa fa-eye-slash"></i></button>
                                            </span>
                                            <input type="password" class="form-control" id="git_token" name="git_token" value="${config['git_token']}" data-parsley-trigger="change">
                                        </div>
                                    </div>
                                </div>
                                <p class="help-block">可选：在检查更新时使用您自己的 GitHub API 令牌。
                            </div>
                        </div>

                        % if plexpy.INSTALL_TYPE == 'git':
                        <div class="form-group advanced-setting">
                            <label for="git_branch">Git 远程 / 分支</label> ${docker_msg | n}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group git-group">
                                        <input type="text" class="form-control" id="git_remote" name="git_remote" value="${config['git_remote']}" data-parsley-trigger="change" ${docker_setting}>
                                        <select class="form-control" id="git_branch" name="git_branch" ${docker_setting}>
                                            <% branches = ('master', 'beta', 'nightly') %>
                                            % for branch in branches:
                                            <option value="${branch}" ${'selected' if config['git_branch'] == branch else ''}>${branch}</option>
                                            % endfor
                                            % if config['git_branch'] not in branches:
                                            <option value="${config['git_branch']}" selected>${config['git_branch']}</option>
                                            % endif
                                        </select>
                                        <span class="input-group-btn">
                                            <button class="btn btn-form" type="button" id="switch_git_branch" ${docker_setting}>切换分支</button>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <p class="help-block">git 追踪的远程和分支（默认为"origin/master"）。选择以切换 git 分支（需要重新启动）。</p>
                        </div>
                        <div class="form-group advanced-setting">
                            <label for="git_path">Git 路径</label> ${docker_msg | n}
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="git_path" name="git_path" value="${config['git_path']}" size="30" ${docker_setting}>
                                </div>
                            </div>
                            <p class="help-block">可选项：您的 git 环境变量的路径。留空使用默认值。</p>
                        </div>
                        <div class="form-group advanced-setting">
                            <label>修复 Git 安装</label>
                            <p class="help-block">
                                尝试通过将您的Tautulli安装重置回 <strong>${common.RELEASE}</strong> 来修复更新问题。<br />
                                注意：这不会影响任何保存的历史记录或设置。
                            </p>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="btn-group">
                                        <button class="btn btn-form" type="button" id="reset_git_install">重置</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        % endif

                        <p><input type="button" class="btn btn-bright save-button" value="保存" data-success="Changes saved successfully"></p>

                    </div>

                    <div role="tabpanel" class="tab-pane" id="tabs-homepage">

                        <div class="padded-header">
                            <h3>活动</h3>
                        </div>

                        <div class="form-group">
                            <label for="home_refresh_interval">活动刷新间隔</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="home_refresh_interval" name="home_refresh_interval" value="${config['home_refresh_interval']}" size="5" data-parsley-min="2" data-parsley-trigger="change" data-parsley-errors-container="#home_refresh_interval_error" required>
                                </div>
                                <div id="home_refresh_interval_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">设置主页上刷新当前活动的间隔时间（以秒为单位）。最小值为2，默认值为10。</p>
                        </div>

                        <div class="padded-header">
                            <h3>章节</h3>
                        </div>

                        <p class="help-block">
                            选择在主页上显示的部分。
                            将下面的项目拖动以重新排列主页内容。
                        </p>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled" id="sortable_home_sections" data-parsley-trigger="change">
                                    <li class="card card-sortable">
                                        <div class="card-handle"><i class="fa fa-bars"></i></div>
                                        <label>
                                            <input type="checkbox" id="hsec-current_activity" name="hsec-current_activity" value="current_activity"> 当前活动
                                        </label>
                                    </li>
                                    <li class="card card-sortable">
                                        <div class="card-handle"><i class="fa fa-bars"></i></div>
                                        <label>
                                            <input type="checkbox" id="hsec-watch_stats" name="hsec-watch_stats" value="watch_stats"> 观看统计
                                        </label>
                                    </li>
                                    <li class="card card-sortable">
                                        <div class="card-handle"><i class="fa fa-bars"></i></div>
                                        <label>
                                            <input type="checkbox" id="hsec-library_stats" name="hsec-library_stats" value="library_stats"> 库统计数据
                                        </label>
                                    </li>
                                    <li class="card card-sortable">
                                        <div class="card-handle"><i class="fa fa-bars"></i></div>
                                        <label>
                                            <input type="checkbox" id="hsec-recently_added" name="hsec-recently_added" value="recently_added"> 最近添加的
                                        </label>
                                    </li>
                                </ul>
                                <input type="text" id="home_sections" name="home_sections" style="display: none;"/>
                            </div>
                        </div>

                        <div class="padded-header">
                            <h3>观看统计</h3>
                        </div>

                        <div class="form-group">
                            <p class="help-block">
                                在主页上选择要显示在观看统计中的卡片。
                                将下面的项目拖动以重新排列您的主页内容。
                            </p>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled" id="sortable_home_stats_cards" data-parsley-trigger="change">
                                        <li class="card card-sortable">
                                            <div class="card-handle"><i class="fa fa-bars"></i></div>
                                            <label>
                                                <input type="checkbox" id="hscard-top_movies" name="hscard-top_movies" value="top_movies"> 最多观看的电影
                                            </label>
                                        </li>
                                        <li class="card card-sortable">
                                            <div class="card-handle"><i class="fa fa-bars"></i></div>
                                            <label>
                                                <input type="checkbox" id="hscard-popular_movies" name="hscard-popular_movies" value="popular_movies"> 最流行的电影
                                            </label>
                                        </li>
                                        <li class="card card-sortable">
                                            <div class="card-handle"><i class="fa fa-bars"></i></div>
                                            <label>
                                                <input type="checkbox" id="hscard-top_tv" name="hscard-top_tv" value="top_tv"> 最多观看的电视剧
                                            </label>
                                        </li>
                                        <li class="card card-sortable">
                                            <div class="card-handle"><i class="fa fa-bars"></i></div>
                                            <label>
                                                <input type="checkbox" id="hscard-popular_tv" name="hscard-popular_tv" value="popular_tv"> 最流行的电视剧
                                            </label>
                                        </li>
                                        <li class="card card-sortable">
                                            <div class="card-handle"><i class="fa fa-bars"></i></div>
                                            <label>
                                                <input type="checkbox" id="hscard-top_music" name="hscard-top_music" value="top_music"> 最多收听的艺术家
                                            </label>
                                        </li>
                                        <li class="card card-sortable">
                                            <div class="card-handle"><i class="fa fa-bars"></i></div>
                                            <label>
                                                <input type="checkbox" id="hscard-popular_music" name="hscard-popular_music" value="popular_music"> 最流行的艺术家
                                            </label>
                                        </li>
                                        <li class="card card-sortable">
                                            <div class="card-handle"><i class="fa fa-bars"></i></div>
                                            <label>
                                                <input type="checkbox" id="hscard-last_watched" name="hscard-last_watched" value="last_watched"> Last Watched
                                            </label>
                                        </li>
                                        <li class="card card-sortable">
                                            <div class="card-handle"><i class="fa fa-bars"></i></div>
                                            <label>
                                                <input type="checkbox" id="hscard-top_libraries" name="hscard-top_libraries" value="top_libraries"> 最活跃的库
                                            </label>
                                        </li>
                                        <li class="card card-sortable">
                                            <div class="card-handle"><i class="fa fa-bars"></i></div>
                                            <label>
                                                <input type="checkbox" id="hscard-top_users" name="hscard-top_users" value="top_users"> 最活跃用户
                                            </label>
                                        </li>
                                        <li class="card card-sortable">
                                            <div class="card-handle"><i class="fa fa-bars"></i></div>
                                            <label>
                                                <input type="checkbox" id="hscard-top_platforms" name="hscard-top_platforms" value="top_platforms"> 最活跃的平台
                                            </label>
                                        </li>
                                        <li class="card card-sortable">
                                            <div class="card-handle"><i class="fa fa-bars"></i></div>
                                            <label>
                                                <input type="checkbox" id="hscard-most_concurrent" name="hscard-most_concurrent" value="most_concurrent"> 最大并发流
                                            </label>
                                        </li>
                                    </ul>
                                    <input type="text" id="home_stats_cards" name="home_stats_cards" style="display: none;" />
                                </div>
                            </div>
                        </div>

                        <div class="padded-header">
                            <h3>库统计数据</h3>
                        </div>

                        <div class="form-group">
                            <p class="help-block">
                                在主页上选择要显示在库统计信息中的卡片。
                                将下面的项目拖动以重新排列主页内容。
                            </p>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled" id="sortable_home_library_cards" data-parsley-trigger="change"></ul>
                                    <input type="text" id="home_library_cards" name="home_library_cards" style="display: none;" />
                                </div>
                            </div>
                        </div>

                        <p><input type="button" class="btn btn-bright save-button" value="保存" data-success="Changes saved successfully"></p>

                    </div>

                    <div role="tabpanel" class="tab-pane" id="tabs-web_interface">

                        <div class="padded-header">
                            <h3>Web界面</h3>
                        </div>

                        <p class="help-block">注意：Web界面的更改需要重新启动。</p>
                        % if common.PLATFORM in ('Windows', 'Darwin'):
                        <%
                            tray = {'Windows': 'System Tray', 'Darwin': 'Menu Bar'}
                            tray_disabled = tray_disabled_msg = ''
                            if common.PLATFORM == 'Darwin':
                                from plexpy.macos import HAS_PYOBJC
                                if not HAS_PYOBJC:
                                    tray_disabled = 'disabled'
                                    tray_disabled_msg = '<span class="setting-message small">(Missing pyobjc module)</span>'
                        %>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" class="http-settings" name="sys_tray_icon" id="sys_tray_icon" value="1" ${config['sys_tray_icon']} ${tray_disabled}> 启用 ${tray[common.PLATFORM]} 图标 ${tray_disabled_msg | n}
                            </label>
                            <p class="help-block">在 ${tray[common.PLATFORM].lower()} 中显示 Tautulli 快捷方式。</p>
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="launch_startup" id="launch_startup" value="1" ${config['launch_startup']}> 系统启动时自动启动
                            </label>
                            <p class="help-block">在登录后自动启动 Tautulli。</p>
                        </div>
                        % endif
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="launch_browser" id="launch_browser" value="1" ${config['launch_browser']}> 启动时启动浏览器
                            </label>
                            <p class="help-block">启动时打开浏览器并指向 Tautulli。</p>
                        </div>
                        <div class="form-group">
                            <label for="http_port">HTTP端口</label> ${docker_msg | n}
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control http-settings" data-parsley-type="integer" id="http_port" name="http_port" value="${config['http_port']}" data-parsley-trigger="change" data-parsley-errors-container="#http_port_error" required ${docker_setting}>
                                </div>
                                <div id="http_port_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">绑定Web服务器的端口。请注意，端口号低于1024可能需要root权限。</p>
                        </div>
                        <div class="form-group advanced-setting">
                            <label for="http_base_url">公共 Tautulli 域名</label>
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="http_base_url" name="http_base_url" value="${config['http_base_url']}" placeholder="http://mydomain.com" data-parsley-trigger="change" data-parsley-pattern="^https?:\/\/\S+$" data-parsley-errors-container="#http_base_url_error"  data-parsley-error-message="Invalid URL">
                                </div>
                                <div id="http_base_url_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">
                                设置您的公共Tautulli域名，用于自托管的通知图片和新闻简报。（例如，http://mydomain.com）
                            </p>
                        </div>
                        <div class="form-group advanced-setting">
                            <label for="http_root">HTTP 根目录</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" class="form-control http-settings" id="http_root" name="http_root" value="${config['http_root']}" data-parsley-trigger="change">
                                </div>
                            </div>
                            <p class="help-block"Web服务器的基本URL。用于反向代理。</p>
                        </div>
                       <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" class="http-settings" name="http_proxy" id="http_proxy" value="1" ${config['http_proxy']}> 启用 HTTP 代理
                            </label>
                            <p class="help-block">请尊重 X-Forwarded-Proto 头部。用于带有 SSL 的反向代理。</p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" class="http-settings" name="enable_https" id="enable_https" value="1" ${config['enable_https']} /> 启用 HTTPS
                            </label>
                            <p class="help-block">为Web服务器启用HTTPS以进行加密通信。</p>
                        </div>
                        <div id="https_options">
                            <div class="checkbox advanced-setting">
                                <label>
                                    <input type="checkbox" class="http-settings" name="https_create_cert" id="https_create_cert" value="1" ${config['https_create_cert']} /> 创建自签名证书
                                </label>
                                <p class="help-block">请勾选以让Tautulli创建一个自签名的SSL证书。如果您想使用自己的证书，请取消勾选。</p>
                            </div>
                            <div id="https_options_self-signed">
                                <div class="form-group advanced-setting">
                                    <label for="https_domain">HTTPS 域名</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control http-settings" id="https_domain" name="https_domain" value="${config['https_domain']}">
                                        </div>
                                    </div>
                                    <p class="help-block">用于访问Tautulli的域名，用逗号（,）分隔。</p>
                                </div>
                                <div class="form-group advanced-setting">
                                    <label for="https_ip">HTTPS IP地址</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control http-settings" id="https_ip" name="https_ip" value="${config['https_ip']}">
                                        </div>
                                    </div>
                                    <p class="help-block">用逗号（,）分隔的用于访问Tautulli的IP地址。</p>
                                </div>
                            </div>
                            <div class="form-group advanced-setting">
                                <label for="https_cert">HTTPS证书</label>
                                <div class="row">
                                    <div class="col-md-7">
                                        <div class="input-group">
                                            <input type="text" class="form-control http-settings" id="https_cert" name="https_cert" value="${config['https_cert']}">
                                            <span class="input-group-btn">
                                                <button class="btn btn-form" type="button" id="https_cert_browse" data-toggle="browse" data-filter=".pem" data-target="#https_cert">Browse</button>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <p class="help-block">PEM格式的SSL证书的位置。</p>
                            </div>
                            <div class="form-group advanced-setting">
                                <label for="https_cert_chain">HTTPS证书链</label>
                                <div class="row">
                                    <div class="col-md-7">
                                        <div class="input-group">
                                            <input type="text" class="form-control http-settings" id="https_cert_chain" name="https_cert_chain" value="${config['https_cert_chain']}">
                                            <span class="input-group-btn">
                                                <button class="btn btn-form" type="button" id="https_cert_chain_browse" data-toggle="browse" data-filter=".pem" data-target="#https_cert_chain">Browse</button>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <p class="help-block">SSL证书链的位置，格式为PEM。</p>
                            </div>
                            <div class="form-group advanced-setting">
                                <label for="https_key">HTTPS密钥</label>
                                <div class="row">
                                    <div class="col-md-7">
                                        <div class="input-group">
                                            <input type="text" class="form-control http-settings" id="https_key" name="https_key" value="${config['https_key']}">
                                            <span class="input-group-btn">
                                                <button class="btn btn-form" type="button" id="https_key_browse" data-toggle="browse" data-filter=".pem" data-target="#https_key">Browse</button>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <p class="help-block">SSL密钥的位置，以PEM格式。</p>
                            </div>
                        </div>

                        <div class="padded-header">
                            <h3>认证</h3>
                        </div>

                        <p class="help-block">注意：身份验证更改需要重新启动。</p>
                        <div class="form-group">
                            <label for="http_username">HTTP用户名</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" class="form-control auth-settings" id="http_username" name="http_username" value="${config['http_username']}" size="30">
                                </div>
                            </div>
                            <p class="help-block">用于Web服务器身份验证的用户名。留空以禁用。</p>
                        </div>
                        <div class="form-group">
                            <label for="http_password">HTTP密码</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="password" class="form-control auth-settings" id="http_password" name="http_password" value="${config['http_password']}" size="30" autocomplete="new-password">
                                </div>
                            </div>
                            <p class="help-block">用于Web服务器身份验证的密码。留空以禁用。</p>
                        </div>

                        <input type="checkbox" name="auth_changed" id="auth_changed" value="1" style="display: none;">

                        <div class="checkbox">
                            <label>
                                <input type="checkbox" class="auth-settings" name="http_plex_admin" id="http_plex_admin" value="1" ${config['http_plex_admin']} data-parsley-trigger="change"> 允许 Plex 管理员
                            </label>
                            <span id="allowPlexCheck" class="settings-warning"></span>
                            <p class="help-block">允许 Plex 服务器管理员使用他们的 Plex.tv 账户登录为 Tautulli 管理员。</p>
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" id="allow_guest_access" name="allow_guest_access" value="1" ${config['allow_guest_access']}> 允许访客访问Tautulli
                            </label>
                            <span id="allowGuestCheck" class="settings-warning"></span>
                            <p class="help-block">允许共享用户使用他们的Plex.tv账户登录Tautulli。需要从“用户”>“编辑模式”中启用单独的用户访问权限。</p>
                        </div>

                        <div class="padded-header">
                            <h3>API</h3>
                        </div>

                        <div class="checkbox">
                            <label>
                                <input type="checkbox" id="api_enabled" name="api_enabled" value="1" ${config['api_enabled']}> 启用 API
                            </label>
                            <p class="help-block">允许外部应用与Tautulli进行接口交互。</p>
                        </div>
                        <div id="apioptions">
                            <div class="form-group">
                                <label for="api_key">API密钥</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-btn">
                                                <button class="btn btn-form reveal-token" type="button"><i class="fa fa-eye-slash"></i></button>
                                            </span>
                                            <input type="password" class="form-control" name="api_key" id="api_key" value="${config['api_key']}" size="20" readonly>
                                            <span class="input-group-btn">
                                                <button class="btn btn-form" type="button" id="generate_api">生成</button>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <p class="help-block">用于访问Tautulli API的API密钥。</p>
                            </div>
                        </div>

                        <p><input type="button" class="btn btn-bright save-button" value="保存" data-success="Changes saved successfully"></p>

                    </div>

                    <div role="tabpanel" class="tab-pane" id="tabs-plex_media_server">

                        <div class="padded-header">
                            <h3 id="resources-xml">Plex 媒体服务器 <small style="color: #fff;">版本<span id="pms_version">${config['pms_version']}</span></small></h3>
                        </div>

                        <div class="form-group has-feedback" id="pms_ip_group">
                            <label for="pms_ip_selectize">Plex IP地址或主机名</label>
                            <div class="row">
                                <div class="col-md-9" id="selectize-pms-ip-container">
                                    <div class="input-group">
                                        <select class="form-control pms-settings selectize-pms-ip" id="pms_ip_selectize" data-parsley-trigger="change" aria-describedby="server-verified" data-parsley-errors-container="#pms_ip_error" required>
                                            <option value="${config['pms_ip']}:${config['pms_port']}"
                                                    data-identifier="${config['pms_identifier']}"
                                                    data-ip="${config['pms_ip']}"
                                                    data-port="${config['pms_port']}"
                                                    data-local="${int(not int(config['pms_is_remote']))}"
                                                    data-ssl="${config['pms_ssl']}"
                                                    data-is_cloud="${config['pms_is_cloud']}"
                                                    data-label="${config['pms_name'] or 'Local'}"
                                                    selected>${config['pms_ip']}</option>
                                        </select>
                                        <span class="input-group-btn">
                                            <button class="btn btn-form" type="button" id="verify_server_button">验证服务器</button>
                                        </span>
                                    </div>
                                    <span class="form-control-feedback" id="pms_verify" aria-hidden="true" style="display: none; right: 110px;"></span>
                                </div>
                                <div id="pms_ip_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">从下拉菜单中选择您的 Plex 媒体服务器，或输入 IP 地址或主机名。</p>
                        </div>
                        <div class="form-group">
                            <label for="pms_port">Plex 端口</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input data-parsley-type="integer" class="form-control pms-settings" type="text" id="pms_port" name="pms_port" value="${config['pms_port']}" size="30" data-parsley-trigger="change" data-parsley-errors-container="#pms_port_error" required>
                                </div>
                                <div id="pms_port_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">Plex Media Server正在监听的端口。</p>
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" id="pms_ssl_checkbox" class="checkbox-toggle pms-settings" data-id="pms_ssl" value="1" ${checked(config['pms_ssl'])}> 使用安全连接
                                <input type="hidden" id="pms_ssl" name="pms_ssl" value="${config['pms_ssl']}">
                            </label>
                            <p class="help-block">如果您已启用<a href="${anon_url('https://support.plex.tv/articles/206225077-how-to-use-secure-server-connections')}" target="_blank" rel="noreferrer">安全连接</a>，请使用HTTPS连接到您的Plex服务器。</p>
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" id="pms_is_remote_checkbox" class="checkbox-toggle pms-settings" data-id="pms_is_remote" value="1" ${checked(config['pms_is_remote'])}> 远程服务器
                                <input type="hidden" id="pms_is_remote" name="pms_is_remote" value="${config['pms_is_remote']}">
                            </label>
                            <p class="help-block">如果你的Plex服务器不在与Tautulli相同的本地网络上，请勾选此选项。</p>
                        </div>
                        <div class="form-group">
                            <label for="pms_url">Plex 服务器网址</label>
                            <div class="row">
                                <div class="col-md-9">
                                    <input type="text" class="form-control" id="pms_url" name="pms_url" value="${config['pms_url']}" size="30" readonly>
                                </div>
                            </div>
                            <p class="help-block">
                                Tautulli将用于连接到您的Plex服务器的服务器URL。自动检索。
                            </p>
                        </div>
                        <div class="form-group advanced-setting">
                            <label for="pms_url">Plex 服务器标识符</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-btn">
                                            <button class="btn btn-form reveal-token" type="button"><i class="fa fa-eye-slash"></i></button>
                                        </span>
                                        <input type="password" class="form-control" id="pms_identifier" name="pms_identifier" value="${config['pms_identifier']}" size="30" readonly>
                                    </div>
                                </div>
                            </div>
                            <p class="help-block">
                                您的Plex服务器的唯一标识符。自动检索。
                            </p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" class="pms-settings" id="pms_url_manual" name="pms_url_manual" value="1" ${config['pms_url_manual']}> 手动连接
                            </label>
                            <p class="help-block">使用用户定义的连接详细信息。不要自动检索服务器连接URL。</p>
                        </div>
                        <div class="form-group advanced-setting">
                            <label for="pms_web_url">Plex Web 网址</label>
                            <div class="row">
                                <div class="col-md-9">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="pms_web_url" name="pms_web_url" value="${config['pms_web_url']}" size="30" data-parsley-trigger="change" data-parsley-pattern="^https?:\/\/\S+$|^https:\/\/app.plex.tv\/desktop$" data-parsley-errors-container="#pms_web_url_error"  data-parsley-error-message="Invalid Plex Web URL">
                                        <span class="input-group-btn">
                                            <button class="btn btn-form" type="button" id="test_pms_web_button">测试网址</button>
                                        </span>
                                    </div>
                                </div>
                                <div id="pms_web_url_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">
                                可选：手动覆盖用于媒体信息页面和通知中的点击链接的 Plex Web URL。默认为<strong>https://app.plex.tv/desktop</strong>。
                            </p>
                        </div>

                        <input type="hidden" id="pms_ip" name="pms_ip" value="${config['pms_ip']}">
                        <input type="hidden" id="pms_is_cloud" name="pms_is_cloud" value="${config['pms_is_cloud']}">
                        <input type="checkbox" name="server_changed" id="server_changed" value="1" style="display: none;">

                        <div class="form-group advanced-setting">
                            <label for="pms_logs_folder">Plex 日志文件夹</label>
                            <div class="row">
                                <div class="col-md-7">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="pms_logs_folder" name="pms_logs_folder" value="${config['pms_logs_folder']}" size="30" data-parsley-trigger="change" data-parsley-pattern="^[^\~\%]" data-parsley-errors-container="#pms_logs_folder_error"  data-parsley-error-message="Shortcuts are not recognized.">
                                        <span class="input-group-btn">
                                            <button class="btn btn-form" type="button" id="pms_logs_folder_browse" data-toggle="browse" data-filter=".folderonly" data-target="#pms_logs_folder">浏览</button>
                                        </span>
                                    </div>
                                </div>
                                <div id="pms_logs_folder_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">
                                可选：将您的Plex日志文件夹设置为使用Tautulli作为日志查看器。Tautulli的功能不需要Plex日志。
                                需要提供完整的文件夹路径，不支持快捷方式，并且日志必须可以从安装Tautulli的机器上访问。
                                <a href="${anon_url('https://support.plex.tv/hc/en-us/articles/200250417-Plex-Media-Server-Log-Files')}" target="_blank" rel="noreferrer">点击这里</a>获取帮助。
                            </p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" id="cache_images" name="cache_images" value="1" ${config['cache_images']}> 缓存 Plex 图像
                            </label>
                            <p class="help-block">
                                启用缓存功能，将 Plex 中的图像缓存以减少 API 调用并提高加载速度。<br />
                                注意：视频预览缩略图（BIF）不会被缓存。
                            </p>
                        </div>

                        <div class="padded-header">
                            <h3>Server Monitoring</h3>
                        </div>

                        <div class="checkbox">
                            <label>
                                <input type="checkbox" id="monitor_pms_updates" name="monitor_pms_updates" value="1" ${config['monitor_pms_updates']}> 监控 Plex 更新
                            </label>
                            <p class="help-block">启用 Tautulli 检查 Plex Media Server 是否有可用的更新。</p>
                        </div>
                        <div id="pms_update_options">
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="pms_update_channel">更新通道</label>
                                        <select class="form-control" id="pms_update_channel" name="pms_update_channel">
                                            <option value="plex">使用服务器设置</option>
                                            <option value="public">公共</option>
                                        </select>
                                    </div>
                                    <div class="col-md-5">
                                        <label for="pms_update_distro_build">发布</label>
                                        <select class="form-control" id="pms_update_distro_build" name="pms_update_distro_build">
                                        </select>
                                        <input type="hidden" class="form-control" id="pms_update_distro" name="pms_update_distro">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="pms_update_check_interval">Plex 更新检查间隔</label>
                                <div class="row">
                                    <div class="col-md-2">
                                        <input type="text" class="form-control" data-parsley-type="integer" id="pms_update_check_interval" name="pms_update_check_interval" value="${config['pms_update_check_interval']}" size="3" data-parsley-min="1" data-parsley-trigger="change" data-parsley-errors-container="#pms_update_check_interval_error" required>
                                    </div>
                                    <div id="pms_update_check_interval_error" class="alert alert-danger settings-alert" role="alert"></div>
                                </div>
                                <p class="help-block">
                                    Tautulli 将检查新的 Plex Media Server 更新的时间间隔（以小时为单位）。最小值为 1 ，默认值为 24 。
                                </p>
                            </div>
                            <div class="checkbox advanced-setting">
                                <label>
                                    <input type="checkbox" name="notify_server_update_repeat" id="notify_server_update_repeat" value="1" ${config['notify_server_update_repeat']}> 重复 Plex 服务器更新通知
                                </label>
                                <p class="help-block">
                                    启用此选项，允许 Tautulli 在每次检查更新时发送重复的 Plex 服务器更新通知。
                                    禁用仅发送一条有关每个 Plex 服务器版本的通知。
                                </p>
                            </div>
                        </div>

                        <div class="form-group advanced-setting">
                            <label for="refresh_users_interval">用户列表刷新间隔</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="refresh_users_interval" name="refresh_users_interval" value="${config['refresh_users_interval']}" size="5" data-parsley-range="[1,24]" data-parsley-trigger="change" data-parsley-errors-container="#refresh_users_interval_error" required>
                                </div>
                                <div id="refresh_users_interval_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">Tautulli 将从 Plex.tv 请求更新的好友列表的时间间隔（以小时为单位）。最小值为 1 ，最大值为 24 ，默认值为 12 。</p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" id="refresh_users_on_startup" name="refresh_users_on_startup" value="1" ${config['refresh_users_on_startup']}> 启动时刷新用户列表
                            </label>
                            <p class="help-block">当Tautulli启动时，刷新用户列表。</p>
                        </div>

                        <div class="form-group advanced-setting">
                            <label for="refresh_libraries_interval">库列表刷新间隔</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="refresh_libraries_interval" name="refresh_libraries_interval" value="${config['refresh_libraries_interval']}" size="5" data-parsley-range="[1,24]" data-parsley-trigger="change" data-parsley-errors-container="#refresh_libraries_interval_error" required>
                                </div>
                                <div id="refresh_libraries_interval_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">Tautulli 将从你的 Plex 媒体服务器请求更新的库列表的时间间隔（以小时为单位）。最小值为 1，最大值为 24，默认值为 12。</p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" id="refresh_libraries_on_startup" name="refresh_libraries_on_startup" value="1" ${config['refresh_libraries_on_startup']}> 启动时刷新库列表
                            </label>
                            <p class="help-block">Tautulli 启动时刷新库列表。</p>
                        </div>

                        <div class="padded-header">
                            <h3>Plex.tv 身份验证</h3>
                        </div>

                        <div class="form-group has-feedback">
                            <label for="pms_token">Plex.tv 账户令牌</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <button id="sign-in-plex" class="btn btn-form" type="button">获取新令牌</button>
                                    <span style="margin-left: 10px; display: none;" id="pms-token-status"></span>
                                </div>
                            </div>
                            <p class="help-block">获取一个新的 Plex.tv 账户认证令牌。</p>
                        </div>
                        <input type="hidden" id="pms_client_id" name="pms_client_id" value="${config['pms_client_id']}">

                        <p><input type="button" class="btn btn-bright save-button" value="保存" data-success="Changes saved successfully"></p>

                    </div>

                    <div role="tabpanel" class="tab-pane" id="tabs-notifications">

                        <div class="padded-header">
                            <h3>当前活动通知</h3>
                        </div>

                        <div class="form-group">
                            <label for="buffer_threshold">缓冲阈值</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="buffer_threshold" name="buffer_threshold" value="${config['buffer_threshold']}" data-parsley-range="[0,50]" data-parsley-trigger="change" data-parsley-errors-container="#buffer_threshold_error" required>
                                </div>
                                <div id="buffer_threshold_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">
                                触发第一次通知之前所需的缓冲事件数量。
                                如果播放状态为缓冲，则每次收到 WebSocket 消息时，缓冲事件都会递增。
                                <br>
                                注意：缓冲警告仅适用于某些 Plex 客户端。某些客户端可能会发送过多的缓冲消息，或者根本不发送任何消息。
                                此通知可能不可靠，不代表真实问题的存在。
                            </p>
                        </div>
                        <div class="form-group advanced-setting">
                            <label for="buffer_wait">缓冲等待</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="buffer_wait" name="buffer_wait" value="${config['buffer_wait']}" data-parsley-min="0" data-parsley-trigger="change" data-parsley-errors-container="#buffer_wait_error" required>
                                </div>
                                <div id="buffer_wait_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">Tautulli在触发下一个缓冲警告之前应等待的时间值（以秒为单位）。设置为0以始终触发。</p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" name="notify_consecutive" id="notify_consecutive" value="1" ${config['notify_consecutive']}> 允许播放停止通知超过观看百分比
                            </label>
                            <p class="help-block">
                                在超过观看百分比后，允许发送播放停止通知。
                                禁用仅在观看百分比以下发送播放停止通知。
                            </p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" name="notify_concurrent_by_ip" id="notify_concurrent_by_ip" value="1" ${config['notify_concurrent_by_ip']}> 按IP地址的用户并发流通知
                            </label>
                            <p class="help-block">
                                允许仅由单个用户从不同的IP地址发送并发流通知。
                                无论IP地址如何，只要超过并发流量阈值，就禁止发送并发流量通知。
                            </p>
                        </div>
                        <div class="form-group">
                            <label for="notify_concurrent_threshold">用户并发流量阈值</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="notify_concurrent_threshold" name="notify_concurrent_threshold" value="${config['notify_concurrent_threshold']}" data-parsley-min="2" data-parsley-trigger="change" data-parsley-errors-container="#notify_concurrent_threshold_error" required>
                                </div>
                                <div id="notify_concurrent_threshold_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">单个用户通过Tautulli同时观看的流媒体数量，以触发通知。最少为2个。</p>
                        </div>
                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" name="notify_new_device_initial_only" id="notify_new_device_initial_only" value="1" ${config['notify_new_device_initial_only']}> 用户新设备仅首次通知
                            </label>
                            <p class="help-block">
                                只有在用户首次使用新设备进行流媒体时，才发送新设备通知。
                                在设备流媒体被记录在历史记录中之前（即超过忽略间隔），禁止每次用户从设备流媒体时发送新设备通知。
                            </p>
                        </div>
                        <div class="form-group advanced-setting">
                            <label for="notify_concurrent_threshold">持续会话阈值</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="notify_continued_session_threshold" name="notify_continued_session_threshold" value="${config['notify_continued_session_threshold']}" data-parsley-min="0" data-parsley-trigger="change" data-parsley-errors-container="#notify_continued_session_threshold_error" required>
                                </div>
                                <div id="notify_continued_session_threshold_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">
                                停止和开始新流之间的秒数，以被视为连续会话。设置为0以将所有流视为新会话。
                                <br>
                                注意：阈值仅由“初始流”通知参数使用，用于确定流是否是连续流传输会话的第一个流。
                            </p>
                        </div>

                        <div class="padded-header">
                            <h3>最近添加的通知</h3>
                        </div>

                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="notify_group_recently_added_parent" id="notify_group_recently_added_parent" value="1" ${config['notify_group_recently_added_parent']}> 按季或专辑分组通知
                            </label>
                            <p class="help-block">
                                当添加多个剧集或曲目时，只发送一个季或专辑的通知。电影、单集和单曲不受影响。<br />
                                注意：可以显示一系列的剧集/音轨（例如01-12），但所有其他剧集/音轨的元数据将无法使用。
                            </p>
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="notify_group_recently_added_grandparent" id="notify_group_recently_added_grandparent" value="1" ${config['notify_group_recently_added_grandparent']}> 按电视节目或艺术家分组通知
                            </label>
                            <p class="help-block">
                                当添加多个季或专辑时，只发送一条电视节目或艺术家通知。电影、单集和单曲不受影响。<br />
                                注意：可以显示季范围（例如1-3），但所有其他季/集数/专辑/曲目的元数据将不可用。
                            </p>
                        </div>
                        <div class="form-group">
                            <label for="notify_recently_added_delay">最近添加的通知延迟</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="notify_recently_added_delay" name="notify_recently_added_delay" value="${config['notify_recently_added_delay']}" size="5" data-parsley-min="60" data-parsley-trigger="change" data-parsley-errors-container="#notify_recently_added_delay_error" required>
                                </div>
                                <div id="notify_recently_added_delay_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">将延迟时间（以秒为单位）设置为等待连续最近添加的项目进行分组，并在发送最近添加通知之前允许元数据处理。最小值为60秒，默认为300秒。</p>
                        </div>
                        <div class="form-group advanced-setting">
                            <label>刷新最近添加的内容</label>
                            <p class="help-block">
                                尝试通过清空数据库中所有最近添加的项目来修复最近添加的通知问题。<br />
                                警告：这将重置所有最近添加的通知。仅在最近添加的通知卡住时紧急使用！
                            </p>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="btn-group">
                                        <button class="btn btn-form" type="button" id="delete_recently_added">Flush</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--<div class="checkbox">
                            <label>
                                <input type="checkbox" name="notify_recently_added_upgrade" id="notify_recently_added_upgrade" value="1" ${config['notify_recently_added_upgrade']}> Send a Notification for New Versions <span class="settings-warning">[Not working]</span>
                            </label>
                            <p class="help-block">
                                Enable to send another recently added notification when adding a new version of existing media.<br />
                                Note: If multiple versions are available, Tautulli will assume the higher quality one is newer.
                            </p>
                        </div>-->

                        <div class="padded-header">
                            <h3>服务器通知</h3>
                        </div>

                        <div class="form-group">
                            <label for="notify_server_connection_threshold">Plex 服务器宕机阈值</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="notify_server_connection_threshold" name="notify_server_connection_threshold" value="${config['notify_server_connection_threshold']}" size="5" data-parsley-min="60" data-parsley-trigger="change" data-parsley-errors-container="#notify_server_connection_threshold_error" required>
                                </div>
                                <div id="notify_server_connection_threshold_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">Plex 服务器宕机后发送通知之前的持续时间（以秒为单位）。最小值为 60，默认值为 60。</p>
                        </div>
                        <div class="form-group">
                            <label for="notify_remote_access_threshold">远程访问宕机阈值</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="notify_remote_access_threshold" name="notify_remote_access_threshold" value="${config['notify_remote_access_threshold']}" size="5" data-parsley-min="60" data-parsley-trigger="change" data-parsley-errors-container="#notify_remote_access_threshold_error" required>
                                </div>
                                <div id="notify_remote_access_threshold_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">Plex远程访问在发送通知之前的中断持续时间（以秒为单位）。最小值为60，默认值为60。</p>
                        </div>

                        <div class="padded-header">
                            <h3>新闻简报</h3>
                        </div>

                        <div class="checkbox">
                            <label>
                                <input type="checkbox" id="newsletter_self_hosted" name="newsletter_self_hosted" value="1" ${config['newsletter_self_hosted']}> 自托管的新闻简报
                            </label>
                            <p class="help-block">可以在您自己的域名上托管通讯订阅。这将生成一个链接到一个HTML页面，您可以在该页面上查看通讯订阅。</p>
                        </div>
                        <div id="self_host_newsletter_options" style="overflow: hidden; display: ${'block' if config['newsletter_self_hosted'] == 'checked' else 'none'}">
                            <div class="form-group">
                                <p class="help-block" id="self_host_newsletter_message">
                                    Note: The <span class="inline-pre">${http_root}newsletter</span> 您的域名上的端点必须能够从互联网公开访问。
                                </p>
                                <p class="help-block settings-warning base-url-warning">警告：未在<a data-tab-destination="web_interface" data-target="http_base_url">Web界面</a>下设置公共Tautulli域名。</p>
                            </div>
                            <div class="form-group">
                                <label for="newsletter_auth">通讯认证</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <select class="form-control" id="newsletter_auth" name="newsletter_auth">
                                            <option value="0" ${'selected' if config['newsletter_auth'] == 0 else ''}>禁用</option>
                                            <option value="1" ${'selected' if config['newsletter_auth'] == 1 else ''}>密码</option>
                                            <option value="2" ${'selected' if config['newsletter_auth'] == 2 else ''}>Tautulli 客人访问</option>
                                        </select>
                                    </div>
                                </div>
                                <p class="help-block">选择用于自托管通讯的身份验证方法。</p>
                                <p class="help-block settings-warning newsletter-guest-access-warning">警告：在<a data-tab-destination="web_interface" data-target="allow_guest_access">Web界面</a>下未启用访客访问权限。</p>
                            </div>
                            <div class="form-group" id="newsletter_password_option">
                                <label for="newsletter_password">通讯密码</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-btn">
                                                <button class="btn btn-form reveal-token" type="button"><i class="fa fa-eye-slash"></i></button>
                                            </span>
                                            <input type="password" class="form-control" id="newsletter_password" name="newsletter_password" value="${config['newsletter_password']}">
                                        </div>
                                    </div>
                                </div>
                                <p class="help-block">输入将用于查看自托管通讯的密码。</p>
                            </div>
                        </div>

                        <div class="checkbox advanced-setting">
                            <label>
                                <input type="checkbox" id="newsletter_inline_styles" name="newsletter_inline_styles" value="1" ${config['newsletter_inline_styles']}> 使用内联样式模板
                            </label>
                            <p class="help-block">
                                启用使用内联CSS样式的通讯模板。内联样式在电子邮件客户端中呈现效果更好，但文件大小较大，可能导致较长的通讯被截断。<br>
                                注意：此设置不影响自定义模板。CSS样式将取决于您自己的模板。
                            </p>
                        </div>
                        <div class="form-group advanced-setting">
                            <label for="newsletter_custom_dir">自定义通讯模板文件夹</label>
                            <div class="row">
                                <div class="col-md-7">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="newsletter_custom_dir" name="newsletter_custom_dir" value="${config['newsletter_custom_dir']}">
                                        <span class="input-group-btn">
                                            <button class="btn btn-form" type="button" id="newsletter_custom_dir_browse" data-toggle="browse" data-filter=".folderonly" data-target="#newsletter_custom_dir">浏览</button>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <p class="help-block">可选：输入您自定义的通讯模板文件夹的完整路径。留空使用默认设置。</p>
                        </div>
                        <div class="form-group advanced-setting">
                            <label for="newsletter_dir">Newsletter Output Directory</label> ${docker_msg | n}
                            <div class="row">
                                <div class="col-md-7">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="newsletter_dir" name="newsletter_dir" value="${config['newsletter_dir']}" ${docker_setting}>
                                        <span class="input-group-btn">
                                            <button class="btn btn-form" type="button" id="newsletter_dir_browse" data-toggle="browse" data-filter=".folderonly" data-target="#newsletter_dir" ${docker_setting}>浏览</button>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <p class="help-block">请输入将要保存通讯文件的完整路径。</p>
                        </div>

                        <p><input type="button" class="btn btn-bright save-button" value="保存" data-success="Changes saved successfully"></p>

                    </div>

                    <div role="tabpanel" class="tab-pane" id="tabs-notification_agents">

                        <div class="padded-header">
                            <h3>通知代理</h3>
                        </div>

                        <p class="help-block">
                            点击下方的项目，添加一个新的通知代理，或者配置一个已存在的通知代理。
                        </p>
                        <p class="help-block">
                            请参考<a href="${anon_url('https://github.com/%s/%s/wiki/Notification-Agents-Guide' % (plexpy.CONFIG.GIT_USER, plexpy.CONFIG.GIT_REPO))}" target="_blank" rel="noreferrer">通知代理指南</a>，了解如何设置每个通知代理。
                        </p>
                        <br />
                        <div id="plexpy-notifiers-table">
                            <div class='text-muted'><i class="fa fa-refresh fa-spin"></i> 正在加载通知代理...</div>
                            <br>
                        </div>

                    </div>

                    <div role="tabpanel" class="tab-pane" id="tabs-newsletter_agents">

                        <div class="padded-header">
                            <h3>通讯代理</h3>
                        </div>

                        <p class="help-block">
                            点击下方的项目，添加一个新的通讯订阅代理，或配置现有的通讯订阅代理。
                        </p>
                        <p class="help-block settings-warning" id="newsletter_upload_warning">
                            警告：必须启用<a data-tab-destination="3rd_party_apis" data-target="notify_upload_posters">图像托管</a>设置，以便在通讯中显示图像。
                        </p>
                        <br/>
                        <div id="plexpy-newsletters-table">
                            <div class='text-muted'><i class="fa fa-refresh fa-spin"></i> 正在加载通讯代理...</div>
                            <br>
                        </div>

                    </div>

                    <div role="tabpanel" class="tab-pane" id="tabs-3rd_party_apis">

                        <div class="padded-header">
                            <h3>图片托管</h3>
                        </div>

                        <p class="help-block">图像托管用于为某些通知代理和新闻简报提供海报和艺术作品。</p>

                        <div class="form-group">
                            <label for="notify_upload_posters">Image Host</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="${'input-group' if config['notify_upload_posters'] in (1, 3) else ''}">
                                        <select class="form-control" id="notify_upload_posters" name="notify_upload_posters">
                                            <option value="0" ${'selected' if config['notify_upload_posters'] == 0 else ''}>禁用</option>
                                            <option value="1" ${'selected' if config['notify_upload_posters'] == 1 else ''}>Imgur</option>
                                            <option value="3" ${'selected' if config['notify_upload_posters'] == 3 else ''}>Cloudinary</option>
                                            <option value="2" ${'selected' if config['notify_upload_posters'] == 2 else ''}>自托管在公共域名上</option>
                                        </select>
                                        % if config['notify_upload_posters'] in (1, 3):
                                        <span class="input-group-btn" id="delete_all_uploads_container">
                                            <button class="btn btn-form" type="button" id="delete_all_uploads">删除所有上传内容</button>
                                        </span>
                                        % endif
                                    </div>
                                </div>
                            </div>
                            <p class="help-block">选择在哪里托管Plex图像以用于通知和新闻简报。</p>
                        </div>
                        <div id="imgur_upload_options" style="overflow: hidden; display: ${'none' if config['notify_upload_posters'] != 1 else 'block'}">
                            <div class="form-group">
                                <p class="help-block">
                                    请参考<a href="${anon_url('https://github.com/%s/%s/wiki/3rd-Party-APIs-Guide' % (plexpy.CONFIG.GIT_USER, plexpy.CONFIG.GIT_REPO))}" target="_blank" rel="noreferrer">第三方API指南</a>以获取有关设置Imgur的说明。<br>
                                    警告：Imgur上传受到速率限制，可能超过限制。请改用Cloudinary来发送新闻简报。
                                </p>
                            </div>
                            <div class="form-group">
                                <label for="imgur_client_id">Imgur Client ID</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-btn">
                                                <button class="btn btn-form reveal-token" type="button"><i class="fa fa-eye-slash"></i></button>
                                            </span>
                                            <input type="password" class="form-control" id="imgur_client_id" name="imgur_client_id" value="${config['imgur_client_id']}" data-parsley-trigger="change">
                                        </div>
                                    </div>
                                </div>
                                <p class="help-block">请输入你的Imgur API Client ID。</p>
                            </div>
                        </div>
                        <div id="self_host_image_options" style="overflow: hidden; display: ${'none' if config['notify_upload_posters'] != 2 else 'block'}">
                            <div class="form-group">
                                <p class="help-block" id="self_host_image_message">注意：你的域名上的<span class="inline-pre">${http_root}image</span>端点必须对外公开访问。</p>
                                <p class="help-block settings-warning base-url-warning">警告：未在<a data-tab-destination="web_interface" data-target="http_base_url">Web界面</a>下设置公共Tautulli域名。</p>
                            </div>
                        </div>
                        <div id="cloudinary_upload_options" style="overflow: hidden; display: ${'none' if config['notify_upload_posters'] != 3 else 'block'}">
                            <div class="form-group">
                                <p class="help-block">
                                    请参考<a href="${anon_url('https://github.com/%s/%s/wiki/3rd-Party-APIs-Guide' % (plexpy.CONFIG.GIT_USER, plexpy.CONFIG.GIT_REPO))}" target="_blank" rel="noreferrer">第三方API指南</a>，了解如何设置Cloudinary。
                                </p>
                            </div>
                            <div class="form-group">
                                <label for="cloudinary_cloud_name">Cloudinary Cloud Name</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-btn">
                                                <button class="btn btn-form reveal-token" type="button"><i class="fa fa-eye-slash"></i></button>
                                            </span>
                                            <input type="password" class="form-control" id="cloudinary_cloud_name" name="cloudinary_cloud_name" value="${config['cloudinary_cloud_name']}" data-parsley-trigger="change">
                                        </div>
                                    </div>
                                </div>
                                <p class="help-block">
                                    请输入您的 Cloudinary 云名称。
                                </p>
                            </div>
                            <div class="form-group">
                                <label for="cloudinary_api_key">Cloudinary API Key</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-btn">
                                                <button class="btn btn-form reveal-token" type="button"><i class="fa fa-eye-slash"></i></button>
                                            </span>
                                            <input type="password" class="form-control" id="cloudinary_api_key" name="cloudinary_api_key" value="${config['cloudinary_api_key']}" data-parsley-trigger="change">
                                        </div>
                                    </div>
                                </div>
                                <p class="help-block">
                                    请输入您的 Cloudinary API 密钥。
                                </p>
                            </div>
                            <div class="form-group">
                                <label for="cloudinary_api_secret">Cloudinary API Secret</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-btn">
                                                <button class="btn btn-form reveal-token" type="button"><i class="fa fa-eye-slash"></i></button>
                                            </span>
                                            <input type="password" class="form-control" id="cloudinary_api_secret" name="cloudinary_api_secret" value="${config['cloudinary_api_secret']}" data-parsley-trigger="change">
                                        </div>
                                    </div>
                                </div>
                                <p class="help-block">
                                    请输入您的 Cloudinary API Secret。
                                </p>
                            </div>
                        </div>

                        <div class="padded-header">
                            <h3>元数据查找</h3>
                        </div>

                        <p class="help-block">当可用时，元数据查找用于提供通知的附加链接。</p>

                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="themoviedb_lookup" id="themoviedb_lookup" value="1" ${config['themoviedb_lookup']}> 查找 TheMovieDB 链接
                            </label>
                            <p class="help-block">当可用时，启用对电影和电视节目的TheMovieDB（如有需要，还可以是IMDb）链接的查找。</p>
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="tvmaze_lookup" id="tvmaze_lookup" value="1" ${config['tvmaze_lookup']}> 查找 TVmaze 链接
                            </label>
                            <p class="help-block">当可用时，启用对电视节目的TVmaze链接（如果需要，还可以包括IMDb链接）。</p>
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="musicbrainz_lookup" id="musicbrainz_lookup" value="1" ${config['musicbrainz_lookup']}> 查找 MusicBrainz 链接
                            </label>
                            <p class="help-block">当音乐可用时，启用对MusicBrainz的链接查找功能。</p>
                        </div>
                        <div class="form-group">
                            <label for="delete_lookup_info">删除查找信息</label>
                            <p class="help-block">删除Tautulli中的所有缓存的元数据查找信息。</p>
                            <div class="row">
                                <div class="col-md-9">
                                    <div class="btn-group">
                                        <button class="btn btn-form delete_all_lookups" type="button" data-service="themoviedb">TheMovieDB</button>
                                        <button class="btn btn-form delete_all_lookups" type="button" data-service="tvmaze">TVmaze</button>
                                        <button class="btn btn-form delete_all_lookups" type="button" data-service="musicbrainz">MusicBrainz</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <p><input type="button" class="btn btn-bright save-button" value="保存" data-success="Changes saved successfully"></p>

                    </div>

                    <div role="tabpanel" class="tab-pane" id="tabs-import_backups">

                        <div class="padded-header">
                            <h3>导入</h3>
                        </div>

                        <div class="form-group">
                            <label for="database_import">数据库导入</label>
                            <p class="help-block">点击下方的按钮，从所选应用中导入现有数据库。</p>
                            <div class="row">
                                <div class="col-md-9">
                                    <div class="btn-group">
                                        <button class="btn btn-form toggle-app-import-modal" type="button" data-target="#app-import-modal" data-toggle="modal" data-app="tautulli">Tautulli</button>
                                        <button class="btn btn-form toggle-app-import-modal" type="button" data-target="#app-import-modal" data-toggle="modal" data-app="plexwatch">PlexWatch</button>
                                        <button class="btn btn-form toggle-app-import-modal" type="button" data-target="#app-import-modal" data-toggle="modal" data-app="plexivity">Plexivity</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="config_import">配置导入</label>
                            <p class="help-block">点击下方按钮以导入之前的 Tautulli 配置。</p>
                            <div class="row">
                                <div class="col-md-9">
                                    <div class="btn-group">
                                        <button class="btn btn-form toggle-config-import-modal" type="button" data-target="#config-import-modal" data-toggle="modal">Tautulli</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="padded-header">
                            <h3>备份</h3>
                        </div>

                        <div class="form-group">
                            <label for="backup_interval">备份间隔</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="backup_interval" name="backup_interval" value="${config['backup_interval']}" size="5" data-parsley-range="[1,24]" data-parsley-trigger="change" data-parsley-errors-container="#backup_interval_error" required>
                                </div>
                                <div id="backup_interval_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">Tautulli 备份数据库和配置文件的间隔时间（以小时为单位）。最小值为 1，最大值为 24，默认值为 6。</p>
                        </div>
                        <div class="form-group">
                            <label for="backup_interval">备份天数</label>
                            <div class="row">
                                <div class="col-md-2">
                                    <input type="text" class="form-control" data-parsley-type="integer" id="backup_days" name="backup_days" value="${config['backup_days']}" size="5" data-parsley-min="1" data-parsley-trigger="change" data-parsley-errors-container="#backup_days_error" required>
                                </div>
                                <div id="backup_days_error" class="alert alert-danger settings-alert" role="alert"></div>
                            </div>
                            <p class="help-block">
                                保留计划备份的天数。最少 1 天，默认 3 天。<br />
                                注意：手动备份不会自动删除。
                            </p>
                        </div>

                        <div class="padded-header">
                            <h3>目录</h3>
                        </div>

                        <div class="form-group">
                            <label for="log_dir">日志目录</label> ${docker_msg | n}
                            <div class="row">
                                <div class="col-md-7">
                                    <div class="input-group">
                                        <input type="text" class="form-control directory-settings" id="log_dir" name="log_dir" value="${config['log_dir']}" ${docker_setting}>
                                        <span class="input-group-btn">
                                            <button class="btn btn-form" type="button" id="log_dir_browse" data-toggle="browse" data-filter=".folderonly" data-target="#log_dir" ${docker_setting}>浏览</button>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="backup_dir">备份目录</label> ${docker_msg | n}
                            <div class="row">
                                <div class="col-md-7">
                                    <div class="input-group">
                                        <input type="text" class="form-control directory-settings" id="backup_dir" name="backup_dir" value="${config['backup_dir']}" ${docker_setting}>
                                        <span class="input-group-btn">
                                            <button class="btn btn-form" type="button" id="backup_dir_browse" data-toggle="browse" data-filter=".folderonly" data-target="#backup_dir" ${docker_setting}>浏览</button>
                                        </span>
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn btn-form" type="button" id="backup_config">备份配置</button>
                                        <button class="btn btn-form" type="button" id="backup_database">备份数据库</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cache_dir">缓存目录</label> ${docker_msg | n}
                            <div class="row">
                                <div class="col-md-7">
                                    <div class="input-group">
                                        <input type="text" class="form-control directory-settings" id="cache_dir" name="cache_dir" value="${config['cache_dir']}" ${docker_setting}>
                                        <span class="input-group-btn">
                                            <button class="btn btn-form" type="button" id="cache_dir_browse" data-toggle="browse" data-filter=".folderonly" data-target="#cache_dir" ${docker_setting}>浏览</button>
                                        </span>
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn btn-form" type="button" id="clear_cache">清除所有缓存</button>
                                        <button class="btn btn-form" type="button" id="clear_image_cache">清除图片缓存</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="export_dir">导出目录</label> ${docker_msg | n}
                            <div class="row">
                                <div class="col-md-7">
                                    <div class="input-group">
                                        <input type="text" class="form-control directory-settings" id="export_dir" name="export_dir" value="${config['export_dir']}" ${docker_setting}>
                                        <span class="input-group-btn">
                                            <button class="btn btn-form" type="button" id="export_dir_browse" data-toggle="browse" data-filter=".folderonly" data-target="#export_dir" ${docker_setting}>浏览</button>
                                        </span>
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn btn-form" type="button" id="clear_exports">清除所有导出</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <p><input type="button" class="btn btn-bright save-button" value="保存" data-success="Changes saved successfully"></p>

                    </div>

                    <div role="tabpanel" class="tab-pane" id="tabs-remote_app">

                        <div class="padded-header">
                            <h3>Tautulli Remote 应用</h3>
                        </div>

                        <div class="form-group">
                            <label>Get the App</label>
                            <p class="help-block">
                                在 <a href="${anon_url('https://play.google.com/store/apps/details?id=com.tautulli.tautulli_remote')}" target="_blank" rel="noreferrer">Google Play</a>
                                或 <a href="${anon_url('https://apps.apple.com/us/app/tautulli-remote/id1570909086?platform=iphone')}" target="_blank" rel="noreferrer">App Store</a>
                                获取 Tautulli Remote 应用，以便从您的移动设备访问 Tautulli。
                                <br />
                            </p>
                            <p class="help-block">
                                <span class="app-badge">
                                    <a href="${anon_url('https://play.google.com/store/apps/details?id=com.tautulli.tautulli_remote')}" target="_blank" rel="noreferrer"><img alt="Get it on Google Play" src="images/google-play-badge.svg" /></a>
                                </span>
                                <span class="app-badge">
                                    <a href="${anon_url('https://apps.apple.com/us/app/tautulli-remote/id1570909086?platform=iphone')}" target="_blank" rel="noreferrer"><img alt="Download on the App Store" src="images/app-store-badge.svg" /></a>
                                </span>
                                <span class="app-badge">
                                    <small>Google Play 和 Google Play 标志是 Google LLC 的商标。</small>
                                    <br>
                                    <small>Apple 和 Apple Logo 是 Apple Inc. 的商标。</small>
                                </span>
                            </p>
                            <br style="clear: both">
                        </div>
                        <div class="form-group">
                            <label>已注册设备</label>
                            <p class="help-block">使用 QR 码注册新设备，或通过点击下方项目配置现有设备。</p>
                            <p id="app_api_msg" style="color: #eb8600;">警告：必须在 <a data-tab-destination="web_interface" data-target="api_enabled">Web 界面</a> 下启用 API 才能使用该应用程序。</p>
                            <br />
                            <div class="row">
                                <div id="plexpy-mobile-devices-table" class="col-md-12">
                                    <div class='text-muted'><i class="fa fa-refresh fa-spin"></i>加载已注册的设备...</div>
                                    <br>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="token_error_bar" style="display: none;">
    <i class="fa fa-exclamation-triangle"></i> 你的 Plex.tv 令牌已失效。<br>
    请<a data-tab-destination="plex_media_server" data-target="sign-in-plex">获取一个新的token</a>.
</div>
</%def>

<%def name="modalIncludes()">
<div id="queue-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="queue-modal"></div>
<div id="guidelines-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="guidelines-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-remove"></i></button>
                <h4 class="modal-title">指南</h4>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-top: 20px; margin-bottom: 20px;">
                    <strong>请阅读 <a href="${anon_url('https://github.com/%s/%s/blob/master/README.md' % (plexpy.CONFIG.GIT_USER, plexpy.CONFIG.GIT_REPO))}" target="_blank" rel="noreferrer">指南</a>
                        在提交新的 <span id="guidelines-type"></span> 之前，请先查看 README 文档中的内容！</strong>
                    <br /><br />
                    您的帖子可能会因未遵守指南而被删除。
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" target="_blank" rel="noreferrer" id="guidelines-continue" class="btn btn-bright">继续</a>
            </div>
        </div>
    </div>
</div>

<div id="support-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="support-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-remove"></i></button>
                <h4 class="modal-title">支持</h4>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-top: 20px; margin-bottom: 20px;">
                    <strong>请在寻求帮助之前阅读 <a href="${anon_url('https://github.com/%s/%s/wiki/Frequently-Asked-Questions' % (plexpy.CONFIG.GIT_USER, plexpy.CONFIG.GIT_REPO))}" target="_blank" rel="noreferrer">常见问题解答</a>！</strong>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" target="_blank" rel="noreferrer" id="support-continue" class="btn btn-bright">继续</a>
            </div>
        </div>
    </div>
</div>

<div id="dateTimeOptionsModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="dateTimeOptionsModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    <i class="fa fa-remove"></i>
                </button>
                <h4 class="modal-title">Date &amp; Time Format Options</h4>
            </div>
            <div class="modal-body">
                % for category in common.DATE_TIME_FORMATS:
                <table class="notification-params time-options">
                    <thead>
                        <tr>
                            <th colspan="3">
                                ${category['category']}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        % for parameter in category['parameters']:
                        <tr>
                            <td><strong>${parameter['value']}</strong></td>
                            <td>${parameter['description']}</td>
                            <td>${parameter['example']}</td>
                        </tr>
                        % endfor
                    </tbody>
                </table>
                % endfor
            </div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>
<div id="app-import-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="app-import-modal"></div>
<div id="config-import-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="config-import-modal"></div>
<div id="add-notifier-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="add-notifier-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-remove"></i></button>
                <h4 class="modal-title">添加通知代理</h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <ul class="stacked-configs list-unstyled">
                                % for agent in sorted(available_notification_agents, key=lambda k: k['label'].lower()):
                                <li class="new-notification-agent pointer" data-id="${agent['id']}">
                                    <span>${agent['label']}</span>
                                </li>
                                % endfor
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <input type="button" class="btn btn-bright" data-dismiss="modal" value="Cancel">
            </div>
        </div>
    </div>
</div>
<div id="add-newsletter-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="add-newsletter-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-remove"></i></button>
                <h4 class="modal-title">Add a Newsletter Agent</h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <ul class="stacked-configs list-unstyled">
                                % for agent in available_newsletter_agents:
                                <li class="new-newsletter-agent pointer" data-id="${agent['id']}">
                                    <span>${agent['label']}</span>
                                </li>
                                % endfor
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <input type="button" class="btn btn-bright" data-dismiss="modal" value="Cancel">
            </div>
        </div>
    </div>
</div>
<div id="notifier-config-modal" class="modal fade wide" tabindex="-1" role="dialog" aria-labelledby="notifier-config-modal"></div>
<div id="newsletter-config-modal" class="modal fade wide" tabindex="-1" role="dialog" aria-labelledby="newsletter-config-modal"></div>
<div id="notify-text-sub-modal" class="modal fade wide" tabindex="-1" role="dialog" aria-labelledby="notify-text-sub-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    <i class="fa fa-remove"></i>
                </button>
                <h4 class="modal-title">Notification Parameters</h4>
            </div>
            <div class="modal-body">
                <div>
                    <p class="help-block">
                        If the value for a selected parameter cannot be provided, it will display as blank.
                    </p>
                    % for category in common.NOTIFICATION_PARAMETERS:
                    <table class="notification-params">
                        <thead>
                            <tr>
                                <th colspan="2">
                                    ${category['category']}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            % for parameter in category['parameters']:
                            <tr>
                                <td><strong>{${parameter['value']}}</strong></td>
                                <td>
                                    ${parameter['description']}
                                    % if parameter.get('example'):
                                    <span class="small-muted">(${parameter['example']})</span>
                                    % endif
                                    % if parameter.get('help_text'):
                                    <p class="small-muted">(${parameter['help_text']})</p>
                                    % endif
                                </td>
                            </tr>
                            % endfor
                        </tbody>
                    </table>
                    % endfor
                </div>
            </div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>
<div id="notify-text-tags-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="notify-text-tags-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-remove"></i></button>
                <h4 class="modal-title">Notification Exclusion Tags</h4>
            </div>
            <div class="modal-body">
                <div>
                    <div style="padding-bottom: 10px;">
                        <p class="help-block">
                            Note: Tags separate the <em>media type</em> that triggered the notifications (i.e. a complete show added to Plex vs. a single episode added to Plex).
                            They <em>do not</em> separate the notification parameters (i.e. <span class="inline-pre">{show_name}</span> vs. <span class="inline-pre">{episode_name}</span>.
                        </p>
                        <p class="help-block">
                            Note: Nesting tags inside each other is not supported.
                        </p>
                    </div>
                    <div>
                        <h4>Movie Tag</h4>
                    </div>
                    <div style="padding-bottom: 10px;">
                        <p class="help-block">All text inside <span class="inline-pre">&lt;movie&gt;&lt;/movie&gt;</span> tags will only be sent when the media type is movie.</p>
                        <p><strong style="color: #fff;">Example:</strong></p>
                        <pre>{title}&lt;movie&gt;({year})&lt;/movie&gt; was recently added to Plex</pre>
                    </div>
                    <div>
                        <h4>Show / Season / Episode Tags</h4>
                    </div>
                    <div style="padding-bottom: 10px;">
                        <p class="help-block">
                            All text inside <span class="inline-pre">&lt;show&gt;&lt;/show&gt;</span>/<span class="inline-pre">&lt;season&gt;&lt;/season&gt;</span>/<span class="inline-pre">&lt;episode&gt;&lt;/episode&gt;</span>
                            tags will only be sent when the media type is show, season, or episode, respectively.
                        </p>
                        <p><strong style="color: #fff;">Example:</strong></p>
                        <pre>{show_name}&lt;season&gt; - Season {season_num}&lt;/season&gt;&lt;episode&gt; - S{season_num}E{episode_num} - {episode_name}&lt;/episode&gt; was recently added to Plex.</pre>
                    </div>
                    <div>
                        <h4>Artist / Album / Track Tag</h4>
                    </div>
                    <div>
                        <p class="help-block">
                            All text inside <span class="inline-pre">&lt;artist&gt;&lt;/artist&gt;</span>/<span class="inline-pre">&lt;album&gt;&lt;/album&gt;</span>/<span class="inline-pre">&lt;track&gt;&lt;/track&gt;</span>
                            tags will only be sent when the media type is artist, album, or track, respectively.
                        </p>
                        <p><strong style="color: #fff;">Example:</strong></p>
                        <pre>{artist_name}&lt;album&gt; - {album_name}&lt;/album&gt;&lt;track&gt; - {album_name} - {track_name}&lt;/track&gt; was recently added to Plex.</pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
<div id="notify-text-modifiers-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="notify-text-modifiers-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-remove"></i></button>
                <h4 class="modal-title">Notification Text Modifiers</h4>
            </div>
            <div class="modal-body">
                <div>
                    <div>
                        <h4>Case Modifiers</h4>
                    </div>
                    <div>
                        <p class="help-block">Notification parameters with the <span class="inline-pre">!u</span> modifier will be converted to uppercase.</p>
                        <p><strong style="color: #fff;">Example:</strong></p>
                        <pre>{video_codec}   --> hevc
{video_codec!u} --> HEVC</pre>
                    </div>
                    <div>
                        <p class="help-block">Notification parameters with the <span class="inline-pre">!l</span> modifier will be converted to lowercase.</p>
                        <p><strong style="color: #fff;">Example:</strong></p>
                        <pre>{content_rating}   --> TV-PG
{content_rating!l} --> tv-pg</pre>
                    </div>
                    <div style="padding-bottom: 10px;">
                        <p class="help-block">Notification parameters with the <span class="inline-pre">!c</span> modifier will be converted to title case.</p>
                        <p><strong style="color: #fff;">Example:</strong></p>
                        <pre>{media_type}   --> movie
{media_type!c} --> Movie</pre>
                    </div>
                    <div>
                        <h4>Time Formats</h4>
                    </div>
                    <div style="padding-bottom: 10px;">
                        <p class="help-block">
                            Notification parameters which are "in date format" or "in time format" can be formatted using the
                            <a href="javascript:void(0)" data-target="#dateTimeOptionsModal" data-toggle="modal">Date & Time Format Options</a>
                            by adding a <span class="inline-pre">:format</span> specifier.
                            If no format is specified, the default Date Format and Time Format under Settings > General will be used.
                        </p>
                        <p><strong style="color: #fff;">Example:</strong></p>
                        <pre>{started_datestamp:ddd, MMMM DD, YYYY}   --> Mon, December 25, 2023
{stopped_timestamp:h:mm a}               --> 9:56 pm
{duration_time:HH:mm:ss}                 --> 01:42:20</pre>
                    </div>
                    <div>
                        <h4>List Slicing</h4>
                    </div>
                    <div style="padding-bottom: 10px;">
                        <p class="help-block">
                            Notification parameters which have a list of items can be sliced with a slice formatter <span class="inline-pre">:[X:Y]</span> to limit the number of items.
                            Note: the first item in the list is numbered <span class="inline-pre">0</span>.
                        </p>
                        <p><strong style="color: #fff;">Example:</strong></p>
                        <pre>{actors:[0]}   --> Only include the 1st actor (Actors: 0)
{actors:[:4]}  --> Only the first 4 actors (Actors: 0, 1, 2, 3)
{actors:[2:]}  --> Only the 3rd to last actors (Actors: 2, 3, 4, ...)
{actors:[1:5]} --> Only the 2nd to 5th actors (Actors: 1, 2, 3, 4)</pre>
                    </div>
                    <div>
                        <h4>Prefix and Suffix</h4>
                    </div>
                    <div style="padding-bottom: 10px;">
                        <p class="help-block">
                            A prefix or a suffix can be added to the notification parameters using <span class="inline-pre">Prefix&lt;</span> and <span class="inline-pre">&gt;Suffix</span>.
                            If the notification parameter is unavailable, the prefix or suffix will not be displayed.
                        </p>
                        <p><strong style="color: #fff;">Example:</strong></p>
                        <pre>{rating}              --> 8.9
{Rating: &lt;rating}     --> Rating: 8.9
{rating&gt;/10}          --> 8.9/10
{Rating: &lt;rating&gt;/10} --> Rating: 8.9/10</pre>
                        <p><strong style="color: #fff;">Example with unavailable parameter:</strong></p>
                        <pre>{rating}              -->
Rating: {rating}/10   --> Rating: /10
{Rating: &lt;rating&gt;/10} --> </pre>
                    </div>
                    <div>
                        <h4>Expressions</h4>
                    </div>
                    <div style="padding-bottom: 10px;">
                        <p class="help-block">
                            注意：<span class="inline-pre">notify_text_eval=1</span> 必须在配置文件中手动启用以启用表达式。
                            启用此设置可能会带来安全风险。请自行承担风险。如果不使用此功能，建议将其禁用。
                        </p>
                        <p class="help-block">
                            通知参数可以用反引号<span class="inline-pre">`expr`</span>包裹起来，以便作为Python表达式进行评估。
                            只有以下函数在表达式中受支持：
                        </p>
                        <ul class="help-block">
                            <li><span class="inline-pre">bool(x)</span></li>
                            <li><span class="inline-pre">divmod(a, b)</span></li>
                            <li><span class="inline-pre">float(x)</span></li>
                            <li><span class="inline-pre">int(x)</span></li>
                            <li><span class="inline-pre">len(s)</span></li>
                            <li><span class="inline-pre">round(n[, ndigits])</span></li>
                            <li><span class="inline-pre">str(x)</span></li>
                        </ul>
                        <p><strong style="color: #fff;">示例：</strong></p>
                        <pre>{`float(rating) * 10`>%}                           --> 89%
{`"%d hr %d min" % divmod(int(duration), 60)`}     --> 1 hr 50 min
{`round(float(stream_bandwidth) / 1000, 1)`> Mbps} --> 6.9 Mbps</pre>
                    </div>
                    <div>
                        <h4>组合</h4>
                    </div>
                    <div>
                        <p class="help-block">
                            如果组合多个通知文本修饰符，则修饰符的顺序必须为：
                        </p>
                        <ol class="help-block">
                            <li>Prefix</li>
                            <li>Evaluation</li>
                            <li>Parameter</li>
                            <li>Case Modifier</li>
                            <li>Time Formats / List Slicing</li>
                            <li>Suffix</li>
                        </ol>
                        <p><strong style="color: #fff;">Example:</strong></p>
                        <pre>{Starring &lt;actors!c:[0]&gt; as the main character.} --> 主演阿诺德·施瓦辛格饰演主角。</pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
<div id="notifier-text-preview-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="notifier-text-preview-modal">
</div>
<div id="newsletter-text-sub-modal" class="modal fade wide" tabindex="-1" role="dialog" aria-labelledby="newsletter-text-sub-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    <i class="fa fa-remove"></i>
                </button>
                <h4 class="modal-title">通讯参数</h4>
            </div>
            <div class="modal-body">
                <div>
                    <p class="help-block">
                        如果所选参数的值不可用，它将显示为空白。
                    </p>
                    % for category in common.NEWSLETTER_PARAMETERS:
                    <table class="notification-params">
                        <thead>
                            <tr>
                                <th colspan="2">
                                    ${category['category']}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            % for parameter in category['parameters']:
                            <tr>
                                <td><strong>{${parameter['value']}}</strong></td>
                                <td>
                                    ${parameter['description']}
                                    % if parameter.get('example'):
                                    <span class="small-muted">(${parameter['example']})</span>
                                    % endif
                                    % if parameter.get('help_text'):
                                    <p class="small-muted">(${parameter['help_text']})</p>
                                    % endif
                                </td>
                            </tr>
                            % endfor
                        </tbody>
                    </table>
                    % endfor
                </div>
            </div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>
<div id="changelog-modal" class="modal fade wide" tabindex="-1" role="dialog" aria-labelledby="changelog-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-remove"></i></button>
                <h4 class="modal-title">更新日志</h4>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <input type="button" class="btn btn-bright" data-dismiss="modal" value="Close">
            </div>
        </div>
    </div>
</div>
<div id="restart-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="restart-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-remove"></i></button>
                <h4 class="modal-title">重新启动</h4>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-top: 20px; margin-bottom: 20px;">
                    您已更改了需要重新启动Tautulli的设置。<br />点击下面的重新启动按钮立即重新启动。
                </div>
            </div>
            <div class="modal-footer">
                <button id="modal_link_restart" class="btn btn-bright"><i class="fa fa-refresh"></i> 重新启动</button>
            </div>
        </div>
    </div>
</div>
<div id="api-qr-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="api-qr-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-remove"></i></button>
                <h4 class="modal-title">注册 Tautulli 远程应用程序</h4>
            </div>
            <div class="modal-body">
                <label>指示</label>
                <p class="help-block">
                    使用Tautulli Remote应用程序扫描下方的二维码，自动将其与服务器注册（请确保下方的Tautulli地址正确），
                    或手动在应用程序设置中输入连接信息和设备令牌。设备注册成功后，此窗口将自动关闭。
                </p>
                <p class="help-block">
                    注意：设备注册时，不得阻止OneSignal.com（例如在Pi-hole中）。
                </p>
                <label>二维码</label>
                <div id="api_qr_code"></div>
                <label>Tautulli 地址</label>
                <input type="text" class="form-control" id="api_qr_address">
                <p class="help-block" id="api_qr_localhost" style="display: none;">
                    注意：<span class="inline-pre">127.0.0.1</span> 和 <span class="inline-pre">localhost</span> 无法使用。
                    请提供一个内部或外部IP地址，或者主机名或域名。
                </p>
                <p class="help-block" id="api_qr_private" style="display: none;">
                    注意：这是一个私有IP地址。Tautulli在你的家庭网络之外是无法访问的。
                    要访问Tautulli，请使用外部地址或手动输入上面的地址以生成远程访问的QR码。
                </p>
                <p class="help-block" id="api_qr_https" style="display: none;">
                    注意：此URL不安全。应用程序与服务器之间的请求将不会被加密。
                    请启用HTTPS以安全地连接应用程序。
                </p>
                <label>Device Token</label>
                <input type="text" class="form-control" id="api_qr_token" readonly>
            </div>
            <div class="modal-footer">
                <input type="button" class="btn btn-bright" data-dismiss="modal" value="Cancel">
            </div>
        </div>
    </div>
</div>
<div id="mobile-device-config-modal" class="modal fade wide" tabindex="-1" role="dialog" aria-labelledby="mobile-device-config-modal"></div>
<div id="browse-path-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="browse-path-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-remove"></i></button>
                <h4 class="modal-title">文件浏览器</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="browse-path">Select a <span id="browse-path-type"></span> Below</label>
                            <div class="row">
                                <div class="col-md-12">
                                    <input type="text" class="form-control" id="browse-path" name="browse-path" value="" size="30" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12" style="height: 400px; overflow: auto;">
                        <ul id="browse-path-list" class="stacked-configs list-unstyled">
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <span id="browse-path-status-message" style="padding-right: 25px;"></span>
                <input type="button" id="select-browse-file" class="btn btn-bright" value="Select">
            </div>
        </div>
    </div>
</div>
</%def>

<%def name="javascriptIncludes()">
<script src="${http_root}js/parsley.min.js"></script>
<script src="${http_root}js/Sortable.min.js"></script>
<script src="${http_root}js/jquery.inputaffix.min.js"></script>
<script src="${http_root}js/kjua.min.js"></script>
<script>
    function getConfigurationTable() {
        $.ajax({
            url: 'get_configuration_table',
            cache: false,
            async: true,
            complete: function(xhr, status) {
                $("#plexpy-configuration-table").html(xhr.responseText);
            }
        });
    }

    function getSchedulerTable() {
        $.ajax({
            url: 'get_scheduler_table',
            cache: false,
            async: true,
            complete: function(xhr, status) {
                $("#plexpy-scheduler-table").html(xhr.responseText);
            }
        });
    }

    function getNotifiersTable() {
        $.ajax({
            url: 'get_notifiers_table',
            cache: false,
            async: true,
            complete: function(xhr, status) {
                $("#plexpy-notifiers-table").html(xhr.responseText);
            }
        });
    }

    function loadNotifierConfig(notifier_id) {
        showMsg('<i class="fa fa-refresh fa-spin"></i>&nbsp; 加载配置', false);
        $.ajax({
            url: 'get_notifier_config_modal',
            data: { notifier_id: notifier_id },
            cache: false,
            async: true,
            complete: function (xhr, status) {
                $("#notifier-config-modal").html(xhr.responseText).modal('show');
                showMsg('<i class="fa fa-check"></i> 配置已加载', false, true, 2000);
            }
        });
    }

    function getNewslettersTable() {
        $.ajax({
            url: 'get_newsletters_table',
            cache: false,
            async: true,
            complete: function(xhr, status) {
                $("#plexpy-newsletters-table").html(xhr.responseText);
            }
        });
    }

    function loadNewsletterConfig(newsletter_id) {
        showMsg('<i class="fa fa-refresh fa-spin"></i>&nbsp; 加载配置', false);
        $.ajax({
            url: 'get_newsletter_config_modal',
            data: { newsletter_id: newsletter_id },
            cache: false,
            async: true,
            complete: function (xhr, status) {
                $("#newsletter-config-modal").html(xhr.responseText).modal('show');
                showMsg('<i class="fa fa-check"></i> 配置已加载', false, true, 2000);
            }
        });
    }

    function getMobileDevicesTable() {
        $.ajax({
            url: 'get_mobile_devices_table',
            cache: false,
            async: true,
            complete: function(xhr, status) {
                $("#plexpy-mobile-devices-table").html(xhr.responseText);
            }
        });
    }

    function loadMobileDeviceConfig(mobile_device_id) {
        showMsg('<i class="fa fa-refresh fa-spin"></i>&nbsp; 加载配置', false);
        $.ajax({
            url: 'get_mobile_device_config_modal',
            data: { mobile_device_id: mobile_device_id },
            cache: false,
            async: true,
            complete: function (xhr, status) {
                $("#mobile-device-config-modal").html(xhr.responseText).modal('show');
                showMsg('<i class="fa fa-check"></i> 配置已加载', false, true, 2000);
            }
        });
    }

    $("#browse-path-modal").on('hidden.bs.modal', function() {
        $("#select-browse-file").unbind('click');
    });

    function openBrowsePath(key, path, filter_ext, file_description, select_target) {
        $("#browse-path-type").text(file_description);
        $("#browse-path-modal").modal('show');

        $("#select-browse-file").click(function () {
            $("#browse-path-modal").modal('hide');
            $(select_target).val($("#browse-path").val()).change();
        });

        browsePath(key, path, filter_ext);
    }

    function browsePath(key, path, filter_ext) {
        $("#browse-path-status-message").html('<i class="fa fa-fw fa-spin fa-refresh"></i>');
        getBrowsePath(key, path, filter_ext).then(function (data) {
            if (data.result === 'error') {
                $("#browse-path-status-message").html("<i class='fa fa-exclamation-triangle'></i> " + data.message);
            } else {
                $("#browse-path-status-message").html("");

                $('#browse-path').val(data.path);
                var browse_list = $('#browse-path-list');
                browse_list.parent().animate({ scrollTop: 0 }, 0);
                browse_list.empty();

                $.each(data.data, function(i, item) {
                    var browse_item = $('<li/>')
                        .html("<span><i class='fa fa-fw fa-" + item.icon + "'></i>&nbsp; " + item.title + "</span>")
                        .addClass(item.type + ' pointer')
                        .data('key', item.key)
                        .data('path', item.path)
                        .appendTo(browse_list)
                });

                $('#browse-path-list li').click(function (){
                    $('#browse-path').val($(this).data('path'));
                    if ($(this).hasClass('folder')) {
                        browsePath($(this).data('key'), null, filter_ext)
                    }
                });
            }
        });
    }

$(document).ready(function() {

    // Javascript to enable link to tab
    var hash = document.location.hash;
    var prefix = "tabs_";
    if (hash) {
        $('.nav-settings #nav-' + hash.replace('#' + prefix, "")).tab('show');
    }

    // Change hash for page-reload
    $('.nav-settings a').on('shown.bs.tab', function (e) {
        window.location.hash = e.target.hash.replace("#", "#" + prefix);
    });

    // Global Variables
    settingsChanged = false;
    serverChanged = false;
    authChanged = false;
    httpChanged = false;
    directoryChanged = false;

    // Alert if leaving the page without saving changes to settings
    window.onbeforeunload = confirmExit;
    function confirmExit() {
        if (settingsChanged) {
            return "Settings were changed without saving!";
        }
    }

    function preSaveChecks(_callback) {
        verifyPMSWebURL();
        setBaseURLSuffix(true);
        if (serverChanged) {
            verifyServer(_callback);
        } else if (typeof _callback === "function") {
            _callback();
        }
    }

    // Alert the user that their changes require a restart.
    function postSaveChecks() {
        if (authChanged || httpChanged || directoryChanged) {
          $('#restart-modal').modal('show');
        }
        getConfigurationTable();
        getSchedulerTable();
        getNotifiersTable();
        getNewslettersTable();
        getMobileDevicesTable();
        loadUpdateDistros();
        setBaseURLSuffix();
        toggleRevealTokens();
        settingsChanged = false;
    }

    var configForm = $("#configUpdate");
    configForm.change(function () {
        settingsChanged = true;
    });

    function saveSettings(showMsg, _callback) {
        if (configForm.parsley().validate()) {
            doAjaxCall('configUpdate', $(this), 'tabs', true, showMsg, _callback);
            return true;
        } else {
            showMsg('<i class="fa fa-exclamation-circle"></i> 请验证您的设置。', false, true, 5000, true);
            return false;
        }
    }

    function advancedSettings() {
        var advanced_button = $('#menu_link_show_advanced_settings');
        if (advanced_button.hasClass('active')) {
            $('.advanced-setting').show();
        } else {
            $('.advanced-setting').hide();
        }
    }

    $('.save-button').click(function() {
        preSaveChecks(function () { saveSettings(true, postSaveChecks) });
    });

    initConfigCheckbox('#api_enabled');
    initConfigCheckbox('#enable_https');
    initConfigCheckbox('#https_create_cert');
    initConfigCheckbox('#check_github');
    initConfigCheckbox('#monitor_pms_updates');
    initConfigCheckbox('#newsletter_self_hosted');

    $('#menu_link_shutdown').click(function() {
        $('#confirm-message').text("Are you sure you want to shutdown Tautulli?");
        $('#confirm-modal').modal();
        $('#confirm-modal').one('click', '#confirm-button', function () {
            window.location.href = 'shutdown';
        });
    });

    $('#menu_link_restart').click(function() {
        $("#confirm-message").text("Are you sure you want to restart Tautulli?");
        $('#confirm-modal').modal();
        $('#confirm-modal').one('click', '#confirm-button', function () {
            window.location.href = 'restart';
        });
    });

    $('#menu_link_update_check').click(function() {
        $(this).html('<i class="fa fa-spin fa-refresh"></i> Checking').prop('disabled', true);
        checkUpdate(function () {
            $('#menu_link_update_check').html('<i class="fa fa-arrow-alt-circle-up"></i> Check for Updates')
                    .prop('disabled', false);
        });
    });

    $('#modal_link_restart').click(function() {
        window.location.href = 'restart';
    });

    $('#menu_link_show_advanced_settings').click(function() {
        $(this).toggleClass('active');
        if ($(this).hasClass('active')) {
            $(this).html('<i class="fa fa-wrench"></i> Hide Advanced');
            $('#show_advanced_settings').val(1);
        } else {
            $(this).html('<i class="fa fa-wrench"></i> Show Advanced');
            $('#show_advanced_settings').val(0);
        }
        advancedSettings()
    });

    advancedSettings();
    getConfigurationTable();
    getSchedulerTable();
    getNotifiersTable();
    getNewslettersTable();
    getMobileDevicesTable();

    $('#changelog-modal-link').on('click', function (e) {
        e.preventDefault();
        $.ajax({
            url: 'get_changelog',
            cache: false,
            async: true,
            complete: function(xhr, status) {
                $("#changelog-modal .modal-body").html(xhr.responseText);
                $('#changelog-modal').modal();
            }
        });
    });

    $("#backup_config").click(function () {
        var msg = 'Are you sure you want to create a backup of the Tautulli config?';
        var url = 'backup_config';
        confirmAjaxCall(url, msg);
    });

    $("#backup_database").click(function () {
        var msg = 'Are you sure you want to create a backup of the Tautulli database?';
        var url = 'backup_db';
        confirmAjaxCall(url, msg);
    });

    $("#clear_cache").click(function () {
        var msg = 'Are you sure you want to clear the Tautulli cache?';
        var url = 'delete_cache';
        confirmAjaxCall(url, msg);
    });

    $("#clear_image_cache").click(function () {
        var msg = 'Are you sure you want to clear the Tautulli image cache?';
        var url = 'delete_image_cache';
        confirmAjaxCall(url, msg);
    });

    $("#clear_exports").click(function () {
        var msg = 'Are you sure you want to clear the Tautulli metadata exports?';
        var url = 'delete_export?delete_all=true';
        confirmAjaxCall(url, msg);
    });

    $("#regroup_history").click(function () {
        var msg = 'Are you sure you want to regroup play history in the database?<br /><br /><strong>This make take a long time for large databases.<br />Regrouping will continue in the background.</strong>';
        var url = 'regroup_history';
        confirmAjaxCall(url, msg);
    });

    $("#delete_temp_sessions").click(function () {
        var msg = 'Are you sure you want to flush the temporary sessions?<br /><br /><strong>This will reset all currently active sessions.</strong>';
        var url = 'delete_temp_sessions';
        confirmAjaxCall(url, msg);
    });

    $("#delete_recently_added").click(function () {
        var msg = 'Are you sure you want to flush the recently added items?<br /><br /><strong>This will reset all recently added notifications.</strong>';
        var url = 'delete_recently_added';
        confirmAjaxCall(url, msg);
    });

    $("#switch_git_branch").click(function () {
        var current_remote = "${config['git_remote']}";
        var current_branch = "${config['git_branch']}";
        var new_remote = $("#git_remote").val();
        var new_branch = $("#git_branch option:selected").val();

        if (new_remote === current_remote && new_branch === current_branch) {
            showMsg('<i class="fa fa-exclamation-circle"></i> 已经在 ' + current_remote + ' ' + current_branch + ' 分支。', false, true, 5000, true)
        } else {
            var msg = 'Are you sure you want to switch to the <strong>' + new_remote + '/' + new_branch + '</strong> branch?' +
                '<br />Switching branches may cause Tautulli to become unstable.<br /><br />Tautulli will restart.';
            $('#confirm-message').html(msg);
            $('#confirm-modal').modal();
            $('#confirm-modal').one('click', '#confirm-button', function () {
                settingsChanged = false;
                window.location.href = 'checkout_git_branch?git_remote=' + new_remote + '&git_branch=' + new_branch;
            });
        }
    });

    $("#reset_git_install").click(function () {
        var msg = 'Are you sure you want to reset your Tautulli installtion back to <strong>${common.RELEASE}</strong>?' +
                '<br /><br />Tautulli will restart.';
        $('#confirm-message').html(msg);
        $('#confirm-modal').modal();
        $('#confirm-modal').one('click', '#confirm-button', function () {
            settingsChanged = false;
            window.location.href = 'reset_git_install';
        });
    });

    $('#api_key').click(function(){ $('#api_key').select() });
    $("#generate_api").click(function() {
        $.get('generate_api_key',
            function (apikey) {
                $('#api_key').val(apikey);
        });
    });

    $( ".http-settings" ).change(function() {
        httpChanged = true;
    });

    $( ".auth-settings" ).change(function() {
        authChanged = true;
        $("#auth_changed").prop('checked', true);
    });

    $( ".directory-settings" ).change(function() {
        directoryChanged = true;
    });

    $( ".pms-settings" ).change(function() {
        serverChanged = true;
        $("#server_changed").prop('checked', true);
        $("#pms_verify").hide();
    });

    $('.checkbox-toggle').click(function () {
        var configToggle = $(this).data('id');
        if ($(this).is(':checked')) {
            $('#'+configToggle).val(1);
        } else {
            $('#'+configToggle).val(0);
        }
    });

    var $select_pms = $('#pms_ip_selectize').selectize({
        createOnBlur: true,
        openOnFocus: true,
        maxItems: 1,
        closeAfterSelect: true,
        sortField: 'label',
        searchField: ['label', 'value'],
        inputClass: 'form-control selectize-input',
        dropdownParent: '#selectize-pms-ip-container',
        render: {
            item: function (item, escape) {
                if (!item.label) {
                    $.extend(item,
                        $(this.revertSettings.$children)
                             .filter('[value="' + item.value + '"]').data()
                    );
                }
                var label = item.label || item.value;
                var caption = item.label ? item.ip : null;
                return '<div data-identifier="' + item.clientIdentifier +
                        '" data-ip="' + item.ip +
                        '" data-port="' + item.port +
                        '" data-local="' + item.local +
                        '" data-ssl="' + item.httpsRequired +
                        '" data-is_cloud="' + item.is_cloud +
                        '" data-label="' + item.label + '">' +
                        '<span class="item-text">' + escape(label) + '</span>' +
                        (caption ? '<span class="item-value">' + escape(caption) + '</span>' : '') +
                        '</div>';
            },
            option: function (item, escape) {
                var label = item.label || item.value;
                var caption = item.label ? item.value : null;
                return '<div data-identifier="' + item.clientIdentifier +
                        '" data-ip="' + item.ip +
                        '" data-port="' + item.port +
                        '" data-local="' + item.local +
                        '" data-ssl="' + item.httpsRequired +
                        '" data-is_cloud="' + item.is_cloud +
                        '" data-label="' + item.label + '">' +
                        escape(label) +
                        (caption ? '<span class="caption">' + escape(caption) + '</span>' : '') +
                        '</div>';
            }
        },
        create: function(input) {
            return {label: '', value: input};
        },
        onInitialize: function () {
            var s = this;
            this.revertSettings.$children.each(function () {
                $.extend(s.options[this.value], $(this).data());
            });
        },
        onChange: function (item) {
            var pms_ip_selected = this.getItem(item)[0];
            var identifier = $(pms_ip_selected).data('identifier');
            var ip = $(pms_ip_selected).data('ip');
            var port = $(pms_ip_selected).data('port');
            var local = $(pms_ip_selected).data('local');
            var ssl = $(pms_ip_selected).data('ssl');
            var is_cloud = $(pms_ip_selected).data('is_cloud');
            var value = $(pms_ip_selected).data('value');

            $("#pms_identifier").val(identifier !== 'undefined' ? identifier : '');
            $('#pms_ip').val(ip !== 'undefined' ? ip : value);
            $('#pms_port').val(port !== 'undefined' ? port : 32400);
            $('#pms_is_remote_checkbox').prop('checked', (local !== 'undefined' && local === 0));
            $('#pms_is_remote').val(local !== 'undefined' && local === 0 ? 1 : 0);
            $('#pms_ssl_checkbox').prop('checked', (ssl !== 'undefined' && ssl === 1));
            $('#pms_ssl').val(ssl !== 'undefined' && ssl === 1 ? 1 : 0);
            $('#pms_is_cloud').val(is_cloud !== 'undefined' && is_cloud === true ? 1 : 0);
            $('#pms_url_manual').prop('checked', false);
            $('#pms_url').val('Please verify your server above to retrieve the URL');
        },
        onDropdownOpen: function() {
            this.clear();
        }
    });
    var select_pms = $select_pms[0].selectize;

    function getServerOptions() {
        $.ajax({
            url: 'discover',
            success: function (result) {
                if (result) {
                    var existing_ip = $('#pms_ip').val();
                    var existing_port = $('#pms_port').val();
                    result.forEach(function (item) {
                        if (item.ip === existing_ip && item.port === existing_port) {
                            select_pms.updateOption(item.value, item);
                        } else {
                            select_pms.addOption(item);
                        }
                    });
                }
            }
        })
    }
    getServerOptions();

    function verifyServer(_callback) {
        var pms_ip = $("#pms_ip").val();
        var pms_port = $("#pms_port").val();
        var pms_identifier = $("#pms_identifier").val();
        var pms_ssl = $("#pms_ssl").val();
        var pms_is_remote = $("#pms_is_remote").val();
        var pms_url_manual = $("#pms_url_manual").is(':checked') ? 1 : 0;

        if (($("#pms_ip").val() !== '') || ($("#pms_port").val() !== '')) {
            $("#pms_verify").html('<i class="fa fa-refresh fa-spin"></i>').fadeIn('fast');
            showMsg('正在验证 Plex 服务器...', true, true, 10000, false);
            $.ajax({
                url: 'get_server_id',
                data: {
                    hostname: pms_ip,
                    port: pms_port,
                    ssl: pms_ssl,
                    remote: pms_is_remote,
                    manual: pms_url_manual,
                    get_url: true,
                    test_websocket: true
                },
                cache: true,
                async: true,
                timeout: 30000,
                error: function (jqXHR, textStatus, errorThrown) {
                    $("#pms_verify").html('<i class="fa fa-close"></i>').fadeIn('fast');
                    $("#pms_ip_group").addClass("has-error");
                    var msg = 'Could not verify your server.'
                    if (textStatus === 'timeout') {
                        msg += ' Server took too long to respond.'
                    } else {
                        msg += ' Error: ' + jqXHR.status
                    }
                    showMsg('<i class="fa fa-exclamation-circle"></i> ' + msg, false, true, 5000, true)
                },
                success: function(xhr, status) {
                    var result = xhr;
                    var identifier = result.identifier;
                    var url = result.url;
                    var ws = result.ws;
                    if (identifier) {
                        $("#pms_identifier").val(identifier);

                        if (url) {
                            $("#pms_url").val(url);
                        }

                        if (ws === false) {
                            $("#pms_verify").html('<i class="fa fa-close"></i>').fadeIn('fast');
                            $("#pms_ip_group").addClass("has-error");
                            showMsg('<i class="fa fa-exclamation-circle"></i> 服务器已找到，但无法连接到 WebSocket 。<br>检查错误，请查看<a href="logs">日志</a>。', false, true, 5000, true)
                        } else {
                            $("#pms_verify").html('<i class="fa fa-check"></i>').fadeIn('fast');
                            $("#pms_ip_group").removeClass("has-error");
                            showMsg('<i class="fa fa-check"></i> 服务器已验证。', false, true, 5000);
                            serverChanged = false;
                        }

                        if (typeof _callback === "function") {
                            _callback();
                        }
                    } else {
                        $("#pms_verify").html('<i class="fa fa-close"></i>').fadeIn('fast');
                        $("#pms_ip_group").addClass("has-error");
                        showMsg('<i class="fa fa-exclamation-circle"></i> 无法验证您的服务器。', false, true, 5000, true)
                    }
                }
            });
        } else {
            $("#pms_verify").html('<i class="fa fa-close"></i>').fadeIn('fast');
            $("#pms_ip_group").addClass("has-error");
            showMsg('<i class="fa fa-exclamation-circle"></i> Plex 的 IP 地址和端口不能为空。', false, true, 5000, true)
        }
    }

    $('#verify_server_button').on('click', function(){
        verifyServer();
    });

    function verifyPMSWebURL() {
        var pms_web_url = $.trim($("#pms_web_url").val());
        $("#pms_web_url").val(pms_web_url || 'https://app.plex.tv/desktop');
    }

    $('#test_pms_web_button').on('click', function(){
        var pms_web_url = $.trim($("#pms_web_url").val());
        window.open(pms_web_url, '_blank');
    });

    $.ajax({
        url: "check_pms_token",
        type: 'GET',
        statusCode: {
            401: function (xhr, status) {
                $("#updatebar").hide();
                $("#token_error_bar").show();
            }
        }
    });

    function OAuthPreFunction() {
        $("#pms-token-status").html('<i class="fa fa-refresh fa-spin"></i>&nbsp; Waiting for authentication...').fadeIn('fast');
    }
    function OAuthSuccessCallback(authToken) {
        $.post('save_pms_token', { token: authToken, client_id: $('#pms_client_id').val() }, function() {
            showMsg('<i class="fa fa-check"></i> 保存了新的 Plex.tv 令牌。', false, true, 5000);
            getServerOptions();
        });
        $("#pms-token-status").html('<i class="fa fa-check"></i>&nbsp; 认证成功。').fadeIn('fast');
        $("#token_error_bar").hide();
    }
    function OAuthErrorCallback() {
        $("#pms-token-status").html('<i class="fa fa-exclamation-circle"></i>&nbsp; 与 Plex.tv 通信出现错误。').fadeIn('fast');
    }

    $('#sign-in-plex').click(function() {
        PlexOAuth(OAuthSuccessCallback, OAuthErrorCallback, OAuthPreFunction, $('#pms_client_id').val(uuidv4()).val());
    });

    // Load database import modal
    $(".toggle-app-import-modal").click(function() {
        $.ajax({
            url: 'import_database_tool',
            data: { app: $(this).data('app') },
            cache: false,
            async: true,
            complete: function(xhr, status) {
                $("#app-import-modal").html(xhr.responseText);
            }
        });
    });

    // Load config import modal
    $(".toggle-config-import-modal").click(function() {
        $.ajax({
            url: 'import_config_tool',
            cache: false,
            async: true,
            complete: function(xhr, status) {
                $("#config-import-modal").html(xhr.responseText);
            }
        });
    });

    pms_version = false;
    pms_logs_debug = false;
    pms_logs = false;

    // Sortable home_sections
    function set_home_sections() {
        var home_sections = [];
        var hsecs = $('[id^=hsec-]').serializeArray();
        $.each(hsecs, function(i, sec) {
            home_sections.push(sec.value);
        });
        $('#home_sections').val(home_sections);
    }

    var sec_cards = ${config['home_sections'] | n};
    sec_cards.reverse().forEach(function (item) {
        $('#hsec-' + item).prop('checked', !$(this).prop('checked'));
        $('#hsec-' + item).closest('li.card').prependTo('#sortable_home_sections');
    });

    Sortable.create(sortable_home_sections, {
        animation: 250,
        onSort: function(elem, ui) {
            set_home_sections();
        }
    });

    $('[id^=hsec-]').change(function() { set_home_sections(); });
    set_home_sections();

    // Sortable home_stats_cards
    function set_home_stats_cards() {
        var home_stats_cards = [];
        var hscards = $('[id^=hscard-]').serializeArray();
        $.each(hscards, function(i, card) {
            home_stats_cards.push(card.value);
        });
        $('#home_stats_cards').val(home_stats_cards);
    }

    var config_cards = ${config['home_stats_cards'] | n};
    config_cards.reverse().forEach(function (item) {
        $('#hscard-' + item).prop('checked', !$(this).prop('checked'));
        $('#hscard-' + item).closest('li.card').prependTo('#sortable_home_stats_cards');
    });

    Sortable.create(sortable_home_stats_cards, {
        animation: 250,
        onSort: function(elem, ui) {
            set_home_stats_cards();
        }
    });

    $('[id^=hscard-]').change(function() { set_home_stats_cards(); });
    set_home_stats_cards();

    // Sortable home_library_cards
    function set_home_library_cards() {
        var home_library_cards = [];
        var hlcards = $('[id^=hlcard-]').serializeArray();
        $.each(hlcards, function(i, card) {
            home_library_cards.push(card.value);
        });
        $('#home_library_cards').val(home_library_cards);
    }

    $.ajax({
        url: 'get_library_sections',
        data: { },
        async: true,
        complete: function (data) {
            libraries_list = $.parseJSON(data.responseText);
            for (var i in libraries_list) {
                var title = libraries_list[i].section_name;
                var key = libraries_list[i].section_id;
                if (key === 999999) { continue; }  // Don't show Live TV library
                $('#sortable_home_library_cards').append(
                    '<li class="card card-sortable">' + 
                        '<div class="card-handle"><i class="fa fa-bars"></i></div>' + 
                        '<label>' + 
                            '<input type="checkbox" id="hlcard-' + key + '" name="hlcard-' + key + '" value="' + key + '"> ' + title + 
                        '</label>' + 
                    '</li>'
                );
            }
            var config_cards = ${config['home_library_cards'] | n};
            config_cards.reverse().forEach(function (item) {
                $('#hlcard-' + item).prop('checked', !$(this).prop('checked'));
                $('#hlcard-' + item).closest('li.card').prependTo('#sortable_home_library_cards');
            });
            $('[id^=hlcard-]').change(function() { set_home_library_cards(); });
            set_home_library_cards()
        }
    });

    Sortable.create(sortable_home_library_cards, {
        animation: 250,
        onSort: function(elem, ui) {
            set_home_library_cards();
        }
    });

    function allowPlexAdminCheck () {
        if ($('#http_username').val() == '' || $('#http_password').val() == '') {
            $("#http_plex_admin").attr("checked", false).attr("disabled", true);
            $("#allowPlexCheck").html("You must set an admin username and password above to allow Plex admin login.");
        } else {
            $("#http_plex_admin").attr("disabled", false);
            $("#allowPlexCheck").html("");
        }
    }
    allowPlexAdminCheck();

    $('#http_username, #http_password').change(function () {
        allowPlexAdminCheck();
    });

    function allowGuestAccessCheck () {
        if ($('#http_username').val() == '' || $('#http_password').val() == '') {
            $("#allow_guest_access").attr("checked", false).attr("disabled", true);
            $("#allowGuestCheck").html("You must set an admin username and password above to allow guest access.");
        } else {
            $("#allow_guest_access").attr("disabled", false);
            $("#allowGuestCheck").html("");
        }
        newsletterPasswordEnabled();
    }
    allowGuestAccessCheck();

    $('#http_username, #http_password').change(function () {
        allowGuestAccessCheck();
    });

    // Load PMS downloads
    function loadUpdateDistros() {
        var update_params_ajax = $.getJSON('get_server_update_params', function (data) { return data; });

        $.when(update_params_ajax).done(function() {
            var update_params = update_params_ajax.responseJSON;

            var plexpass = update_params.plexpass;
            var platform = update_params.pms_platform;
            var update_channel = update_params.pms_update_channel;
            var update_distro = update_params.pms_update_distro;
            var update_distro_build = update_params.pms_update_distro_build;

            $('#pms_update_channel option[value=beta]').remove();
            if (plexpass) {
                $('#pms_update_channel').append($('<option></option>').text('Beta').val('beta'))
            }
            $('#pms_update_channel option[value=' + update_channel + ']').prop('selected', true);

            $.ajax({
                url: 'get_pms_downloads',
                type: 'GET',
                data: { update_channel: update_channel },
                dataType: 'json',
                success: function (downloads) {
                    var platform_downloads = downloads.computer[platform] || downloads.nas[platform];
                    if (platform_downloads) {
                        $("#pms_update_distro_build option").remove();
                        $.each(platform_downloads.releases, function (index, item) {
                            var label = (platform_downloads.releases.length === 1) ? platform_downloads.name : platform_downloads.name + ' - ' + item.label;
                            var selected = (item.distro === update_distro && item.build === update_distro_build) ? true : false;
                            $('#pms_update_distro_build')
                                    .append($('<option></option>')
                                            .text(label)
                                            .val(item.build)
                                            .attr('data-distro', item.distro)
                                            .prop('selected', selected));
                        });
                        $('#pms_update_distro').val($('#pms_update_distro_build option:selected').data('distro'))
                    }
                }
            });
        });
    }
    loadUpdateDistros();


    $('#pms_update_distro_build').change(function () {
        var distro = $("option:selected", this).data('distro')
        $('#pms_update_distro').val(distro)
    });

    // Add a new notification agent
    $('.new-notification-agent').click(function () {
        $.ajax({
            url: 'add_notifier_config',
            data: { agent_id: $(this).data('id') },
            cache: false,
            async: true,
            complete: function (xhr, status) {
                var result = $.parseJSON(xhr.responseText);
                var msg = result.message;
                $('#add-notifier-modal').modal('hide');
                if (result.result === 'success') {
                    showMsg('<i class="fa fa-check"></i> ' + msg, false, true, 5000);
                    loadNotifierConfig(result.notifier_id);
                } else {
                    showMsg('<i class="fa fa-times"></i> ' + msg, false, true, 5000, true);
                }
                getNotifiersTable();
            }
        });
    });

    // Add a new newsletter agent
    $('.new-newsletter-agent').click(function () {
        $.ajax({
            url: 'add_newsletter_config',
            data: { agent_id: $(this).data('id') },
            cache: false,
            async: true,
            complete: function (xhr, status) {
                var result = $.parseJSON(xhr.responseText);
                var msg = result.message;
                $('#add-newsletter-modal').modal('hide');
                if (result.result === 'success') {
                    showMsg('<i class="fa fa-check"></i> ' + msg, false, true, 5000);
                    loadNewsletterConfig(result.newsletter_id);
                } else {
                    showMsg('<i class="fa fa-times"></i> ' + msg, false, true, 5000, true);
                }
                getNewslettersTable();
            }
        });
    });

    $('#http_root').change(function() {
        setBaseURLSuffix();
    });

    function setBaseURLSuffix(clear) {
        if (clear){
            $('#http_base_url').suffix("");
        } else {
            var suffix = $('#http_root').val();
            if (suffix && !suffix.startsWith('/')) {
                suffix = '/' + suffix;
            }
            $('#http_base_url').suffix(suffix);
        }
    }
    setBaseURLSuffix();

    function apiEnabled() {
        var api_enabled = $('#api_enabled').prop('checked');
        $('#app_api_msg').toggle(!(api_enabled));
    }
    apiEnabled();
    $('#api_enabled').click(function () {
        apiEnabled();
    });

    function imageUpload() {
        var upload_val = $('#notify_upload_posters').val();
        if (upload_val === '1') {
            $('#imgur_upload_options').slideDown();
        } else {
            $('#imgur_upload_options').slideUp();
        }
        if (upload_val === '2') {
            $('#self_host_image_options').slideDown();
        } else {
            $('#self_host_image_options').slideUp();
        }
        if (upload_val === '3') {
            $('#cloudinary_upload_options').slideDown();
        } else {
            $('#cloudinary_upload_options').slideUp();
        }
        var parent;
        if (upload_val === '1' || upload_val === '3') {
            parent = $('#notify_upload_posters').parent();
            if ($('#delete_all_uploads_container').length === 0){
                parent.addClass('input-group');
                parent.append(
                    '<span class="input-group-btn" id="delete_all_uploads_container">' +
                    '<button class="btn btn-form" type="button" id="delete_all_uploads">Delete All Uploads</button>' +
                    '</span>');
            }
        } else {
            parent = $('#notify_upload_posters').parent();
            parent.removeClass('input-group');
            $('#delete_all_uploads_container').remove();
        }
    }
    $('#notify_upload_posters').change(function () {
        imageUpload();
    });

    $('body').on('click', '#delete_all_uploads', function () {
        var image_hosting_option = $('#notify_upload_posters').find(':selected');
        var name = image_hosting_option.text();

        var msg = 'Are you sure you want to delete all uploaded images on <strong>' + name + '</strong>?' +
            '<br /><br />All previous links to the images will no longer work. This cannot be undone!';
        var url = 'delete_hosted_images';
        var data = { service: name, delete_all: true };
        confirmAjaxCall(url, msg, data, false);
    });

    $('body').on('click', '.delete_all_lookups', function () {
        var service = $(this).data('service');
        var name = $(this).text();

        var msg = 'Are you sure you want to delete all the metadata lookup info from <strong>' + name + '</strong>?' +
            '<br /><br />Tautulli will lookup the metadata info again the next time a notification is sent.';
        var url = 'delete_lookup_info';
        var data = { service: service, delete_all: true };
        confirmAjaxCall(url, msg, data, false);
    });

    function baseURLSet() {
        var base_url = $('#http_base_url');
        base_url.val(base_url.val().replace(/\/+$/g, ''));
        if ($('#http_base_url').val()) {
            $('.base-url-warning').hide();
        } else {
            $('.base-url-warning').show();
        }
    }
    baseURLSet();

    $('#http_base_url').change(function () {
        baseURLSet();
    });

    function newsletterUploadEnabled() {
        if ($('#notify_upload_posters').val() === '0') {
            $('#newsletter_upload_warning').show();
        } else {
            $('#newsletter_upload_warning').hide();
        }
    }
    newsletterUploadEnabled();

    $('#notify_upload_posters, #newsletter_self_hosted').change(function () {
        baseURLSet();
        newsletterUploadEnabled();
    });

    function newsletterPasswordEnabled() {
        if ($('#newsletter_auth').val() === '1') {
            $('#newsletter_password_option').slideDown();
        } else {
            $('#newsletter_password_option').slideUp();
        }
        if ($('#newsletter_auth').val() === '2' && !($('#allow_guest_access').is(':checked'))) {
            $('.newsletter-guest-access-warning').show();
        } else {
            $('.newsletter-guest-access-warning').hide();
        }
    }
    newsletterPasswordEnabled();

    $('#newsletter_auth').change(function () {
        newsletterPasswordEnabled();
    });

    $('#allow_guest_access').click(function () {
        newsletterPasswordEnabled();
    });

    function gotoSetting(tab, setting){
        $("#nav-tabs-" + tab).click();
        if (setting) {
            _setting = '#' + setting;
            if ($(_setting).closest('.advanced-setting').length && !$('#menu_link_show_advanced_settings').hasClass('active')) {
                $('#menu_link_show_advanced_settings').click()
            }
            var body_container = $('.body-container');
            var scroll_pos = setting ? body_container.scrollTop() + $(_setting).offset().top - 100 : 0;
            body_container.animate({scrollTop: scroll_pos});
            $(_setting).closest('.form-group, .checkbox').delay(500).fadeOut().fadeIn('slow').fadeOut().fadeIn('slow');
        }
    }

    $('body').on('click', 'a[data-tab-destination]', function () {
        var tab = $(this).data('tab-destination');
        var setting = $(this).data('target');
        gotoSetting(tab, setting)
    });

    $('#resources-xml').on('tripleclick', function () {
        openPlexXML('/api/resources', true, {includeHttps: 1});
    });

    var tautulli_news = $('#tautulli-news')
    $.ajax({
        url: 'https://tautulli.com/news/tautulli-news.json',
        type: 'GET',
        dataType: 'json',
        cache: false,
        async: true,
        success: function (data) {
            if (data) {
                var now = moment().endOf('day');
                var news = $('<ul/>').addClass('accordion list-unstyled')
                $.each(data, function (index, news_item) {
                    var date = moment(news_item.date, "YYYY-MM-DD");
                    if (index >= 5) { return false; }
                    var header = $('<div/>').addClass('link').html(
                        '<span class="toggle-left"><i class="fa fa-newspaper fa-fw"></i></span>' +
                        '<span class="news-title">' + news_item.title + '</span>' +
                        '<span class="toggle-right"><i class="fa fa-chevron-down fa-fw"></i></span>' +
                        '<span class="news-date toggle-right">' + date.format($('#date_format').val()) + '</span>');
                    var subtitle = $('<span/>').addClass('news-subtitle').html(news_item.subtitle);
                    var body = $('<span/>').addClass('news-body').html(news_item.body);
                    var content = $('<div/>').addClass('submenu');
                    if (news_item.subtitle) { content.append(subtitle); }
                    content.append(body);
                    var li = $('<li/>').append(header).append(content)
                    if (index === 0 && Math.abs(now.diff(date, 'days')) <= 30) {
                        li.addClass('open');
                        content.css('display', 'block');
                    }
                    news.append(li)
                });
                tautulli_news.html(news);
                var accordion_news = new Accordion(news, false);
            } else {
                tautulli_news.html('<p class="help-block"><i class="fa fa-check"></i>&nbsp; No news available.</p>')
            }
        },
        error: function () {
            tautulli_news.html('<p class="help-block"><i class="fa fa-exclamation-triangle"></i>&nbsp; Failed to retrieve news.</p>')
        }
    });

    $('body').on('click', '[data-toggle=browse]', function () {
        var filter = $(this).data('filter');
        var target = $(this).data('target');
        var path = $(target).val();
        var description = $(this).data('description') || $("label[for='" + target.replace('#', '') + "']").text();
        openBrowsePath(null, path, filter, description, target);
    });

    toggleRevealTokens();
});
</script>
</%def>
